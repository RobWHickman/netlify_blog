---
title: The Knowledge 7th February 2019
author: Robert Hickman
date: '2019-02-07'
slug: the-knowledge-7th-february-2019/
output: pdf_document
categories: []
tags:
  - rstas
  - football
  - the_knowledge
header:
  caption: ''
  image: ''
---



<p>In what is becoming a <a href="http://www.robert-hickman.eu/post/the-knowledge-4th-august-2018/">repeated</a> <a href="http://www.robert-hickman.eu/post/counties_league_points/">series</a>, I enjoy answering trivia questions from The Guardian’s <a href="https://www.theguardian.com/football/series/theknowledge">The Knowledge</a> football trivia column.</p>
<p>There’s a few questions that built up that seemed ammenable to coding answers so I’ve taken a stab at them here</p>
<pre class="r"><code>#munging
library(tidyverse)
library(data.table)
library(zoo)
#english football data
library(engsoccerdata)
#web data scraping
library(rvest)
#plotting
library(openair)</code></pre>
<div id="calendar-boys" class="section level1">
<h1>Calendar Boys</h1>
<p>The first question this week concerns players scoring on (or nearest to) every day of the year</p>
<blockquote class="twitter-tweet" data-lang="en">
<p lang="en" dir="ltr">
Has any player played/or even scored on every date in a calendar year. What’s the nearest anyone has come?
</p>
— David Thomson (<span class="citation">@thomsonionioni</span>) <a href="https://twitter.com/thomsonionioni/status/1090206478479298560?ref_src=twsrc%5Etfw">January 29, 2019</a>
</blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<p>Getting the data for this is the main problem. The best (free) source I tend to use is transfermarkt.com, but data there becomes less reliable from before 2000 (and only has a few years of data from more obscure years where I could believe some players are banging in goals for fun). Nonetheless, it should at least gives us some ideas</p>
<p>For each player sampled we’re going to want the data for each goal scored both for their club and country. Saving the competition data is also useful as it also allows us to sort out friendlies which may or may not count depending on interpretation of the question.</p>
<p>Two quick functions will do this for any given player id</p>
<pre class="r"><code>#create a data frame of club goals
get_club_goals &lt;- function(club_stats) {
  #read the page
  read &lt;- read_html(club_stats)
  
  #get the players names
  name &lt;- read %&gt;%
    html_nodes(&quot;.dataName b&quot;) %&gt;%
    html_text()
    
  #read the table of goals scored and munge together
  club_df &lt;- read %&gt;%
    html_nodes(xpath = &#39;//*[@id=&quot;main&quot;]/div[10]/div/div/div[4]/table&#39;) %&gt;%
    html_table(fill = TRUE) %&gt;%
    as.data.frame() %&gt;%
    select(Date, Minute, Competition.1) %&gt;%
    mutate(minute = as.numeric(gsub(&quot;&#39;.*&quot;, &quot;&quot;, Minute))) %&gt;%
    filter(!is.na(minute)) %&gt;% 
    #convert date to day of the year
    mutate(date = case_when(
      Date != &quot;&quot; ~ strftime(as.Date(Date, &quot;%m/%d/%y&quot;), &quot;%m/%d&quot;)
    )) %&gt;%
    mutate(competition = ifelse(Competition.1 == &quot;&quot;, NA, Competition.1)) %&gt;%
    select(competition, date, minute) %&gt;%
    #fill down the competition and date if missing
    do(na.locf(.)) %&gt;%
    mutate(scored_for = &quot;club&quot;, name = name)
}

#do the same for national team goals
get_nt_goals &lt;- function(nt_stats) {
  read &lt;- read_html(nt_stats)
  
  name &lt;- read %&gt;%
    html_nodes(&quot;.dataName b&quot;) %&gt;%
    html_text()

  goal_table &lt;- read %&gt;%
    html_nodes(xpath = &#39;//*[@id=&quot;main&quot;]/div[10]/div[1]/div[3]/div[4]/table&#39;)
  
  #some players won&#39;t have any national team goals
  #return NA
  if(!is_empty(goal_table)) {
    nt &lt;- goal_table %&gt;%
      html_table(fill = TRUE) %&gt;%
      as.data.frame() %&gt;%
      select(For, Date, Var.11) %&gt;%
      mutate(goals = as.numeric(Var.11)) %&gt;%
      mutate(date = case_when(
        Date != &quot;&quot; ~ strftime(as.Date(Date, &quot;%m/%d/%y&quot;), &quot;%m/%d&quot;)
      )) %&gt;%
      mutate(competition = ifelse(For == &quot;&quot;, NA, For)) %&gt;%
      mutate(competition = na.locf(competition)) %&gt;%
      filter(!is.na(date)) %&gt;%
      select(competition, date, goals) 
    
    #if more than 1 goal is scored on a game it&#39;s counted as two rows
    #separate these out
    if(any(nt$goals != 1)) {
      nt_df &lt;- do.call(&quot;c&quot;, (mapply(rep, c(nt$competition, nt$date), nt$goals))) %&gt;%
        matrix(., 2, byrow = TRUE) %&gt;%
        t() %&gt;%
        as.data.frame() %&gt;%
        select(competition = V1, date = V2)
    } else {
      nt_df &lt;- nt %&gt;%
        select(-goals)
    }
    
    #finish off munging
    df &lt;- nt_df %&gt;%
      mutate(minute = NA, scored_for = &quot;nation&quot;, name = name)
  } else {
    df &lt;- NA
  }
  return(df)
}</code></pre>
<p>Now we can get into the scraping. For each player some parts of the URL stay the same, so lets save those as objects so we don’t have to deal with massive long urls.</p>
<p>I decided to test out the functions using Cristiano Ronaldo as his 675 goals for club and country is (I believe) more than any active player. Pasting the url together and running on the functions does the trick</p>
<pre class="r"><code>#for each player some parts of url stay the same
base_url &lt;- &quot;https://www.transfermarkt.co.uk/&quot;
club_text1 &lt;- &quot;/alletore/spieler/&quot;
club_text2 &lt;- &quot;/saison//verein/0/liga/0/wettbewerb//pos/0/trainer_id/0/minute/0/torart/0/plus/1&quot;
nt_text1 &lt;- &quot;/nationalmannschaft/spieler/&quot;
nt_text2 &lt;- &quot;/verein_id/3300/plus/0?hauptwettbewerb=&amp;wettbewerb_id=&amp;trainer_id=&amp;start=Aug+20%2C+2003&amp;ende=Feb+4%2C+2019&amp;nurEinsatz=2&quot;

#get all the goals scored by Cristiano Ronaldo
ronaldo &lt;- rbind(
  paste0(base_url, &quot;player_name&quot;, club_text1, 8198, club_text2) %&gt;%
    get_club_goals(),
  paste0(base_url, &quot;player_name&quot;, nt_text1, 8198, nt_text2) %&gt;%
    get_nt_goals()
)

#count the number of unique dates scored on
length(unique(ronaldo$date))</code></pre>
<pre><code>## [1] 244</code></pre>
<p>So Ronaldo has scored on 244 of the 366 possible days of the year. It’s not surprising that scoring on <em>every</em> day would be difficult. The club season only runs August-June and there are unlikely to be many possible games to pla in July at all. Plus days such a Christmas are usually taken off from football.</p>
<p>In terms of goals per day using 2019s calendar this looks like (plot made using the <a href="https://cran.r-project.org/web/packages/openair/index.html">openair package</a>:</p>
<pre class="r"><code>ronaldo %&gt;%
  #count goals per date
  group_by(date) %&gt;%
  summarise(goals = n()) %&gt;%
  #convert to 2019 dates
  mutate(date = as.Date(paste0(&quot;2019/&quot;, date))) %&gt;%
  #use calendarPlot from the openair package
  calendarPlot(., pollutant = &quot;goals&quot;, year = 2019)</code></pre>
<p><img src="/post/2019-03-05-The_Knowledge_3_files/figure-html/ronaldo_calendar-1.png" width="672" /></p>
<p>Which shows more deviation in scoring than I thought it would. Nethertheless, from Sepetember-May each year is pretty blocked out, though there is a run of Saturdays this December which could be fertile ground for increasing his total.</p>
<p>Next we need to get a list of likely players who could come close to matching Ronaldo’s record.</p>
<p>For this I took the first page of transfermarkt’s top scorers of the year across all leagues. It’s possible that a player might (e.g.) be on the second page each year and have scored a ton, but I don’t think it’s super likely.</p>
<p>I run this through the top scorers page from 1995 (the earliest year available) to 2018 and grab each player id. Afterwards, save the scraped list as an .rds to preventneeding to continually rescrape the page and put extra load onto the server.</p>
<pre class="r"><code>#the url for the pages of top scorers
top_scorer_ids &lt;- paste0(base_url, 
                         &quot;spieler-statistik/jahrestorschuetzen/&quot;,
                         &quot;statistik/stat/plus/0/galerie/0?jahr=&quot;,
                         1995:2018,
                         &quot;&amp;wettbewerb=alle&amp;monatVon=01&amp;monatBis=12&amp;altersklasse=&amp;&quot;,
                         &quot;land_id=&amp;ausrichtung=alle&amp;spielerposition_id=alle&amp;art=0&quot;) %&gt;%
  #scrape the ids of players
  lapply(., function(year) {
    read_html(year) %&gt;%
      html_nodes(&quot;#yw1 .spielprofil_tooltip&quot;) %&gt;%
      html_attr(&quot;id&quot;)
  }) %&gt;%
  unlist() %&gt;%
  unique()

#save this to prevent need for re-scraping
saveRDS(top_scorer_ids, &quot;transfermarkt_top_scorers.rds&quot;)</code></pre>
<p>Then all that’s left is to scrape the goals for each player whose id we’ve scraped. Again, save this once run, especially as it takes a fair while to complete. For this article the data was scraped on the 5th February 2019</p>
<pre class="r"><code>player_goals &lt;- top_scorer_ids %&gt;%
  #for each player scrape every goal
  lapply(., function(id) {
    goals &lt;- rbind(
      paste0(base_url, &quot;player_name&quot;, club_text1, id, club_text2) %&gt;%
        get_club_goals(),
      paste0(base_url, &quot;player_name&quot;, nt_text1, id, nt_text2) %&gt;%
        get_nt_goals()
    ) %&gt;%
      #remove NAS
      #this is where a player hasn&#39;t scored for their nation
      filter(!is.na(date)) %&gt;%
      mutate(id = id)
  }) %&gt;%
  do.call(rbind, .)

#and save
saveRDS(player_goals, &quot;top_scorer_goals.rds&quot;)</code></pre>
<p>Now we have a list of every goal scored by profilic strikers, we just have to group by each player and count how many dates they’ve scored on. To get the playest with the highest number of unique dates we group by their id and count the length of the unique dates they’ve scored on.</p>
<pre class="r"><code>days_per_player &lt;- player_goals %&gt;%
  #group by player
  group_by(id) %&gt;%
  #count the dates scored on
  summarise(days = length(unique(date))) %&gt;%
  arrange(-days) %&gt;%
  #rejoin the name data back in
  left_join(.,
            player_goals %&gt;%
              select(id, name) %&gt;%
              unique(),
            by = &quot;id&quot;) %&gt;%
  print()</code></pre>
<pre><code>## # A tibble: 413 x 3
##    id     days name             
##    &lt;chr&gt; &lt;int&gt; &lt;chr&gt;            
##  1 8198    244 Cristiano Ronaldo
##  2 28003   210 Messi            
##  3 7349    203 Raúl             
##  4 3455    200 Ibrahimovic      
##  5 3207    189 Henry            
##  6 4257    187 Eto&#39;o            
##  7 3924    173 Drogba           
##  8 48280   173 Cavani           
##  9 44352   172 Suárez           
## 10 7980    171 Villa            
## # ... with 403 more rows</code></pre>
<p>so perhaps unsurprisingly, Ronaldo comes out on top. As expected given the data source, most of the top players are very recent strikers- all of the top 10 were active well into the 2010s. <a href="https://en.wikipedia.org/wiki/Ulf_Kirsten">Ulf Kirsten</a> and <a href="https://en.wikipedia.org/wiki/Toni_Polster">Toni Polster</a> are the torchbearers for strikers from the 90s.</p>
<p>As always in these posts, I try to learn some new stuff as I do them. I thought this might be a good time to try some circular plotting. I don’t think the resultan</p>
<pre class="r"><code>circular_data &lt;- player_goals %&gt;%
  #filter out top 16 scorers
  filter(id %in% days_per_player$id[1:16]) %&gt;%
  #group by month and player and sum
  mutate(month = gsub(&quot;\\/.*&quot;, &quot;&quot;, date)) %&gt;%
  group_by(id, month, competition) %&gt;%
  summarise(goals = n()) %&gt;%
  left_join(.,
            player_goals %&gt;%
              select(id, name) %&gt;%
              unique(),
            by = &quot;id&quot;)

#too many competititon for legend
#sort out into broad groups
competition_types &lt;- data.frame(competition = circular_data$competition) %&gt;%
  unique() %&gt;%
  mutate(competition = as.character(competition)) %&gt;%
  mutate(competition_type = case_when(
    grepl(&quot;MLS&quot;, competition) ~ &quot;Domestic&quot;,
    grepl(&quot;World Cup qualification| Qualifiers&quot;, competition) ~ &quot;International&quot;,
    grepl(&quot;Friendlies&quot;, competition) ~ &quot;International Friendlies&quot;,
    grepl(&quot;World Cup [0-9]{4}|Confederations|EURO [0-9]{4}&quot;, competition) ~ &quot;International Tournament&quot;,
    grepl(&quot;UEFA|Champions League|UI Cup|Cup Winners|European Cup|Europa&quot;, competition) ~ &quot;European&quot;,
    grepl(&quot;Club World&quot;, competition) ~ &quot;International Club&quot;,
    grepl(&quot;Cup|cup|Pokal|copa|Copa|beker|Coupe|coppa|Kupasi|Trophée|Kupa&quot;, competition) ~ &quot;Domestic Cup&quot;
  )) %&gt;%
  mutate(competition_type = ifelse(is.na(competition_type), &quot;Domestic&quot;, competition_type)) %&gt;%
  #convert to factor for plot fill order
  mutate(competition_type = fct_rev(factor(competition_type)))

#plot as circular radar plots
circular_data %&gt;%
  left_join(., competition_types, by = &quot;competition&quot;) %&gt;%
  ggplot(., aes(x = month, y = goals, fill = competition_type)) +
  #convert to polar coordinates
  coord_polar(theta = &quot;x&quot;, start = -.13) +
  geom_bar(stat = &quot;identity&quot;) +
  scale_fill_discrete(name = &quot;Competition Type&quot;) +
  ggtitle(&quot;Goals Per Month for Top 16 Unique Day Scorers&quot;) +
  facet_wrap(~name) +
  theme_minimal() +
  theme(axis.text = element_blank())</code></pre>
<p><img src="/post/2019-03-05-The_Knowledge_3_files/figure-html/plot_circular-1.png" width="672" /></p>
<p>One nice thing that pops out is how Kirsten rarely scored in December/January- probably due to the Bundesliga mid season break.</p>
<p>I also found it interesting that <a href="https://en.wikipedia.org/wiki/Dirk_Kuyt">Dirk Kuyt</a> featured in the top 16, despite not being renowned as a great goalscorer.</p>
<pre class="r"><code>#count total goals per player
left_join(
  days_per_player,
  player_goals %&gt;%
    group_by(id) %&gt;%
    summarise(goals = n()),
  by = &quot;id&quot;
) %&gt;%
  #work out days/total goals
  mutate(proportion_unique = days / goals) %&gt;%
  arrange(-days) %&gt;%
  filter(days &gt; 150) %&gt;%
  select(name, goals, days, proportion_unique) %&gt;%
  arrange(-proportion_unique)</code></pre>
<pre><code>## # A tibble: 34 x 4
##    name      goals  days proportion_unique
##    &lt;chr&gt;     &lt;int&gt; &lt;int&gt;             &lt;dbl&gt;
##  1 Gilardino   231   154             0.667
##  2 Cissé       269   166             0.617
##  3 Signori     260   160             0.615
##  4 Di Vaio     269   165             0.613
##  5 Toni        273   165             0.604
##  6 Kuyt        281   169             0.601
##  7 Lampard     258   154             0.597
##  8 Frei        257   153             0.595
##  9 Drogba      300   173             0.577
## 10 Trézéguet   265   152             0.574
## # ... with 24 more rows</code></pre>
<p>When sorted by how evenly their goals/date coverage is (i.e. the ideal ratio would be 1 goal on every day), Dirk Kuyt pops up again (and did in fact score many more goals than I had assumed). <a href="https://en.wikipedia.org/wiki/Alberto_Gilardino">Alberto Gilardino</a> really stands out as a player who has maximum date coverage desite (relative to other members of the list!) a low number of total goals scored.</p>
<p>I’m not sure what, if any, insight that adds but is a cool piece of trivia.</p>
</div>
<div id="first-losers" class="section level1">
<h1>First Losers</h1>
<blockquote class="twitter-tweet" data-lang="en">
<p lang="en" dir="ltr">
Which club holds the record for most 2nd place finishes in the English top flight?
</p>
— Tom Goddard (<span class="citation">@Tom_Goddard_13</span>) <a href="https://twitter.com/Tom_Goddard_13/status/1092785174046228480?ref_src=twsrc%5Etfw">February 5, 2019</a>
</blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<p>The fist question this week where I get to dive back into <a href="https://github.com/jalapic/engsoccerdata">James Curley’s engsoccerdata package</a> asks which teams have finished second in their league the most.</p>
<p>First lets load up the engsoccerdata for English leagues 1882-2016. I’ve munged it in a pretty verbose way; there’s definitely a faster way to do it but that’s not really necessary. All we need are the indicators used to sort the league (points, goal difference, and goal scored) for every match in a long format.</p>
<pre class="r"><code>eng_data &lt;- engsoccerdata::england %&gt;%
  #select only pertinent variables
  select(Date, Season, home, visitor, hgoal, vgoal, division) %&gt;%
  rename_all(tolower) %&gt;%
  #melt the data to long format
  reshape2::melt(id.vars = c(&quot;date&quot;, &quot;season&quot;, &quot;hgoal&quot;, &quot;vgoal&quot;, &quot;division&quot;),
                 value.name = &quot;team&quot;, variable.name = &quot;location&quot;) %&gt;%
  #this can be done in one step but for sanity
  mutate(result = case_when(
    hgoal &gt; vgoal &amp; location == &quot;home&quot; ~ &quot;W&quot;,
    vgoal &gt; hgoal &amp; location == &quot;visitor&quot; ~ &quot;W&quot;,
    hgoal &lt; vgoal &amp; location == &quot;home&quot; ~ &quot;L&quot;,
    vgoal &lt; hgoal &amp; location == &quot;visitor&quot; ~ &quot;L&quot;,
    vgoal == hgoal ~ &quot;D&quot;
  )) %&gt;%
  #points for a win changed in 1981
  mutate(points = case_when(
    result == &quot;L&quot; ~ 0,
    result == &quot;D&quot; ~ 1,
    result == &quot;W&quot; &amp; season &lt; 1981 ~ 2,
    result == &quot;W&quot; &amp; season &gt; 1980 ~ 3
  )) %&gt;%
  #and get the goal info too
  mutate(goal_diff = case_when(
    location == &quot;home&quot; ~ hgoal - vgoal,
    location == &quot;visitor&quot; ~ vgoal - hgoal
  )) %&gt;%
  mutate(goals = case_when(
    location == &quot;home&quot; ~ hgoal,
    location == &quot;visitor&quot; ~ vgoal
  )) %&gt;%
  #only save the variables we care about then sort
  select(date, season, division, team, points, goals, goal_diff) %&gt;%
  arrange(date, team)</code></pre>
<p>Then find the final positions of each team in each season of English football sorted by points, goal difference and goals for</p>
<pre class="r"><code>final_positions &lt;- eng_data %&gt;%
  setDT() %&gt;%
  #find the match number
  .[, match := 1:.N, by = c(&quot;season&quot;, &quot;team&quot;)] %&gt;%
  #find the cumulative points, goal difference and goals for
  .[, season_points := cumsum(points), by = c(&quot;season&quot;, &quot;team&quot;)] %&gt;%
  .[, season_gd := cumsum(goal_diff), by = c(&quot;season&quot;, &quot;team&quot;)] %&gt;%
  .[, season_g := cumsum(goals), by = c(&quot;season&quot;, &quot;team&quot;)] %&gt;%
  #filter out the final matches totals and order
  .[.[, .I[match == max(match)], by= c(&quot;season&quot;, &quot;division&quot;)]$V1] %&gt;%
  .[order(season, division, -season_points)] %&gt;%
  #assign the final positions
  .[, final_position := 1:.N, by = c(&quot;season&quot;, &quot;division&quot;)] %&gt;%
  .[, c(&quot;team&quot;, &quot;division&quot;, &quot;final_position&quot;)] %&gt;%
  #count by final position
  .[, pos_count := .N, by = c(&quot;team&quot;, &quot;division&quot;, &quot;final_position&quot;)] %&gt;%
  unique()</code></pre>
<p>Then we can filter out those who have finished second most</p>
<pre class="r"><code>second_place &lt;- final_positions %&gt;%
  #filter out second place finishes
  .[final_position == 2] %&gt;%
  .[, c(&quot;team&quot;, &quot;division&quot;, &quot;final_position&quot;, &quot;pos_count&quot;)] %&gt;%
  .[order(-pos_count)] %&gt;%
  print()</code></pre>
<pre><code>##                    team division final_position pos_count
##   1:  Manchester United        1              2        14
##   2:            Arsenal        1              2        12
##   3:          Liverpool        1              2        11
##   4:        Aston Villa        1              2         9
##   5:   Sheffield United        2              2         8
##  ---                                                     
## 202:           Rochdale        4              2         1
## 203: Milton Keynes Dons        3              2         1
## 204:      Burton Albion        3              2         1
## 205:      Oxford United        4              2         1
## 206:         Portsmouth        4              2         1</code></pre>
<p>Perhaps unsurprisingly, most of the teams to finish second have finished second in the top flight. Manchester United lead the way with Arsenal and Liverpool following up.</p>
<p>Bristol City, Charlton Athletic, Oldham Athletic, Blackpool, QPR, Watford and Southampton have finished runners up in the top division without winning it, all having acheived this exactly once.</p>
<p>Plymouth Argyle have perhaps the most heartbreaking run of all though- having finished second in the old 3rd Division South <a href="https://en.wikipedia.org/wiki/Plymouth_Argyle_F.C.#Honours">SIX times in a row between 1922-1927</a> before finally winning it in 1929.</p>
<p>I thought I might as well also plot every teams league finishes as a proportion of their season in the league. Position here refers to total overall position (so 1st in Division two might be 21st overall). The darker the colour, the more likely the team was the end the season in that position. All teams have been sorted by their mean final league position.</p>
<pre class="r"><code>eng_data %&gt;%
  #filter out modern era
  filter(season &gt; 1991) %&gt;%
  setDT() %&gt;%
  #find finish positions and count as above
  .[, match := 1:.N, by = c(&quot;season&quot;, &quot;team&quot;)] %&gt;%
  .[, season_points := cumsum(points), by = c(&quot;season&quot;, &quot;team&quot;)] %&gt;%
  .[, season_gd := cumsum(goal_diff), by = c(&quot;season&quot;, &quot;team&quot;)] %&gt;%
  .[, season_g := cumsum(goals), by = c(&quot;season&quot;, &quot;team&quot;)] %&gt;%
  .[.[, .I[match == max(match)], by= c(&quot;season&quot;, &quot;division&quot;)]$V1] %&gt;%
  .[order(season, division, -season_points)] %&gt;%
  .[, final_position := 1:.N, by = c(&quot;season&quot;, &quot;division&quot;)] %&gt;%
  .[, total_position := 1:.N, by = c(&quot;season&quot;)] %&gt;%
  .[, c(&quot;team&quot;, &quot;division&quot;, &quot;final_position&quot;, &quot;total_position&quot;)] %&gt;%
  .[, pos_count := .N, by = c(&quot;team&quot;, &quot;division&quot;, &quot;final_position&quot;)] %&gt;%
  .[, team_appearances := .N, by = c(&quot;team&quot;)] %&gt;%
  .[, mean_pos := sum(total_position)/team_appearances, by = c(&quot;team&quot;)] %&gt;%
  unique() %&gt;%
  #order by mean position
  .[order(mean_pos)] %&gt;%
  .[, team := fct_rev(fct_relevel(as.factor(team), unique(.$team)))] %&gt;%
  #plot
  ggplot(., aes(x = total_position, y = team)) + 
  geom_tile(aes(alpha = pos_count/team_appearances), fill = &quot;blue&quot;) +
  scale_alpha_continuous(guide = FALSE) +
  ggtitle(&quot;Teams Ordered by Mean Final Position 1992-2016&quot;,
          subtitle = &quot;Weight indicates proportion of finishes in that position&quot;) +
  xlab(&quot;Total League Position&quot;) +
  theme_minimal() +
  theme(axis.text.y = element_text(angle = 10))</code></pre>
<p><img src="/post/2019-03-05-The_Knowledge_3_files/figure-html/all_final_positions-1.png" width="672" /></p>
<p>There’s probably too much data to graph here, but it’s still a fun way to look at 140 years of English football</p>
</div>
<div id="slip-slidin-away" class="section level1">
<h1>Slip Slidin’ Away</h1>
<blockquote class="twitter-tweet" data-lang="en">
<p lang="en" dir="ltr">
As we're starting to reach that time of season (we'll, we are at <a href="https://twitter.com/hashtag/itfc?src=hash&amp;ref_src=twsrc%5Etfw">#itfc</a>)… What's the earliest <em>collectively</em> a team from each of the top 4 English leagues has been relegated?
</p>
— Philip Genochio (<span class="citation">@philipgenochio</span>) <a href="https://twitter.com/philipgenochio/status/1092782376852156416?ref_src=twsrc%5Etfw">February 5, 2019</a>
</blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<p>A similar question involves the earliest teams to get relegated. Obviously for this first we need to know how many teams are relegated from each league per season. Having only really started watching football around the turn of the millenium I was a bit surprised how much this has changed over the years (n.b. I’m only counting automatic relegation- playoffs and re-elections don’t count).</p>
<pre class="r"><code>#manually enter the number of relegation spots per league
relegation_spots &lt;- eng_data %&gt;%
  .[, c(&quot;season&quot;, &quot;division&quot;)] %&gt;%
  unique() %&gt;%
  mutate(relegation_spots = case_when(
    season &gt;= 1995 &amp; division == 1 ~ 3,
    season &gt;= 1994 &amp; division == 1 ~ 4,
    season &gt;= 1991 &amp; division == 1 ~ 3,
    season &gt;= 1990 &amp; division == 1 ~ 2,
    season &gt;= 1973 &amp; division == 1 ~ 3,
    season &gt;= 1898 &amp; division == 1 ~ 2,
    season &gt;= 1995 &amp; division == 2 ~ 3,
    season &gt;= 1994 &amp; division == 2 ~ 4,
    season &gt;= 1991 &amp; division == 2 ~ 3,
    season &gt;= 1990 &amp; division == 2 ~ 2,
    season &gt;= 1988 &amp; division == 2 ~ 3,
    season &gt;= 1986 &amp; division == 2 ~ 2,
    season &gt;= 1973 &amp; division == 2 ~ 3,
    season &gt;= 1921 &amp; division == 2 ~ 2,
    season &gt;= 1920 &amp; division == 2 ~ 1,
    season &gt;= 1919 &amp; division == 2 ~ 3,
    season &gt;= 1995 &amp; division == 3 ~ 4,
    season &gt;= 1994 &amp; division == 3 ~ 5,
    season &gt;= 1991 &amp; division == 3 ~ 4,
    season &gt;= 1990 &amp; division == 3 ~ 3,
    season &gt;= 1988 &amp; division == 3 ~ 4,
    season &gt;= 1986 &amp; division == 3 ~ 3,
    season &gt;= 1958 &amp; division == 3 ~ 4,
    season &gt;= 2002 &amp; division == 4 ~ 2,
    season &gt;= 1996 &amp; division == 4 ~ 1,
    season &gt;= 1993 &amp; division == 4 ~ 0,
    season &gt;= 1992 &amp; division == 4 ~ 1,
    season &gt;= 1990 &amp; division == 4 ~ 0,
    season &gt;= 1986 &amp; division == 4 ~ 1
 )) %&gt;%
  mutate(relegation_spots = ifelse(relegation_spots == 0, NA, relegation_spots))</code></pre>
<p>We then need to work out how many points each team has, and how many they could possibly achieve, after every match in a season.</p>
<pre class="r"><code>possible_positions &lt;- eng_data %&gt;%
    setDT() %&gt;%
  #get the match number
  .[, match := 1:.N, by = c(&quot;season&quot;, &quot;team&quot;)] %&gt;%
  #get the current points for the team
  .[, season_points := cumsum(points), by = c(&quot;season&quot;, &quot;team&quot;)] %&gt;%
  .[order(division, season, match, -season_points)] %&gt;%
  #get the current position for the team
  .[, position := 1:.N, by = c(&quot;division&quot;, &quot;season&quot;, &quot;match&quot;)] %&gt;%
  #how many teams are in the league
  .[, teams := max(position), by = c(&quot;division&quot;, &quot;season&quot;)] %&gt;%
  #find how many matches each team has left to play
  .[, matches_remaining := max(match) - match, by = c(&quot;division&quot;, &quot;season&quot;)] %&gt;%
  #the max points assumes each team wins all of their remaining matches
  .[season &lt; 1981, possible_points := season_points + (matches_remaining * 2)] %&gt;%
  .[season &gt; 1980, possible_points := season_points + (matches_remaining * 3)] %&gt;%
  #merge in the relegation spots and find what position each team needs to be safe
  merge(., relegation_spots, by = c(&quot;division&quot;, &quot;season&quot;)) %&gt;%
  .[, lowest_safe_position := teams - relegation_spots] %&gt;%
  #the threshold for safety is the number of points the lowest safe team has
  .[position == lowest_safe_position, lowest_safe_points := season_points]</code></pre>
<p>Then it’s a simple case of finding teams in the relgation zone and finding the point at which they can no longer catch the lowest safe team</p>
<pre class="r"><code>relegation_secured &lt;- possible_positions %&gt;%
  #filter out teams in relegation trouble
  .[!is.na(lowest_safe_position)] %&gt;%
  .[position &gt;= lowest_safe_position] %&gt;%
  .[, lowest_safe_points := na.locf(lowest_safe_points)] %&gt;%
  .[possible_points &lt; lowest_safe_points] %&gt;%
    .[, c(&quot;season&quot;, &quot;division&quot;, &quot;team&quot;, &quot;season_points&quot;,
          &quot;matches_remaining&quot;, &quot;possible_points&quot;, &quot;lowest_safe_points&quot;)] %&gt;%
  .[order(-matches_remaining)] %&gt;%
  #remove duplicates
  .[!duplicated(paste0(season, division, team))]

head(data.frame(relegation_secured), 15)</code></pre>
<pre><code>##    season division                team season_points matches_remaining
## 1    1973        3            Rochdale            16                 8
## 2    1984        1          Stoke City            17                 7
## 3    2001        2    Stockport County            17                 7
## 4    2003        2           Wimbledon            21                 7
## 5    2016        2    Rotherham United            17                 7
## 6    1961        3      Newport County            18                 7
## 7    1984        3    Cambridge United            17                 7
## 8    1993        3              Barnet            23                 7
## 9    2000        3       Oxford United            22                 7
## 10   1930        1   Manchester United            16                 6
## 11   1954        1 Sheffield Wednesday            19                 6
## 12   1975        1    Sheffield United            13                 6
## 13   1994        1        Ipswich Town            23                 6
## 14   2007        1        Derby County            11                 6
## 15   1952        2            Barnsley            17                 6
##    possible_points lowest_safe_points
## 1               32                 33
## 2               38                 40
## 3               38                 39
## 4               42                 44
## 5               38                 41
## 6               32                 33
## 7               38                 41
## 8               44                 46
## 9               43                 44
## 10              28                 29
## 11              31                 32
## 12              25                 28
## 13              41                 42
## 14              29                 30
## 15              29                 30</code></pre>
<p>So Rochdale hold the questionable honour of being the team knowing they are doomed with the most matches to go (with 8 in division 3 in 1973). There’s quite a large chasing pack of teams who have known with 7 or 6 matches left too. Ipswich are currently ‘only’ 8 points off of safety with 16 games left to go so seems unlikely to beat 8 but it could be close…</p>
<p>I also wanted to see what the earliest a team has ever been certain of their final position is.</p>
<pre class="r"><code>certain_final_positions &lt;- possible_positions %&gt;%
  #find the possible points for the teams above and below each team
  .[, poss_points_nextworst := lead(possible_points), by = c(&quot;season&quot;, &quot;division&quot;, &quot;match&quot;)] %&gt;%
  .[, points_nextbest := lag(season_points), by = c(&quot;season&quot;, &quot;division&quot;, &quot;match&quot;)] %&gt;%
  #filter out teams that cannot beat/fall below the next best/worst teams
  .[(is.na(poss_points_nextworst) | season_points &gt; poss_points_nextworst) &amp; 
      (is.na(points_nextbest) | possible_points &lt; points_nextbest) &amp;
      matches_remaining &gt; 0] %&gt;%
  #order and select columns
  .[order(-matches_remaining)] %&gt;%
  .[, c(&quot;division&quot;, &quot;season&quot;, &quot;team&quot;, &quot;position&quot;, &quot;matches_remaining&quot;, &quot;teams&quot;)]

head(data.frame(certain_final_positions), 15)</code></pre>
<pre><code>##    division season                 team position matches_remaining teams
## 1         4   1968 Bradford Park Avenue       24                 7    24
## 2         1   1984           Stoke City       22                 6    22
## 3         2   1949    Tottenham Hotspur        1                 6    22
## 4         2   1971              Watford       22                 6    22
## 5         2   1973        Middlesbrough        1                 6    22
## 6         2   2001     Stockport County       24                 6    24
## 7         3   1966  Queens Park Rangers        1                 6    24
## 8         3   1984     Cambridge United       24                 6    24
## 9        3b   1952              Walsall       24                 6    24
## 10        4   1968 Bradford Park Avenue       24                 6    24
## 11        4   1977              Watford        1                 6    24
## 12        4   1997         Notts County        1                 6    24
## 13        1   1980       Crystal Palace       22                 5    22
## 14        1   1982            Liverpool        1                 5    22
## 15        1   1984              Everton        1                 5    22</code></pre>
<p>Spare a thought for fans of Bradford Park Avenue in 1968-1969 who knew their team would finish bottom of the 3rd Division North with 7 matches (of 46) remaining. Luckily they wern’t relegated as they were already in the bottom division of the football league and we re-elected for the next season. They repeated this feat, now in Division 4, 5 years later, finishing bottom with 6 games to go.</p>
<p>Most of these involve teams either winning or finishing bottom of their league. If we filter these out we’re left with:</p>
<pre class="r"><code>certain_final_positions %&gt;%
  #filter off bottom or top teams
  .[position != 1 &amp; position != teams] %&gt;%
  data.frame() %&gt;%
  head(., 15)</code></pre>
<pre><code>##    division season                team position matches_remaining teams
## 1        3a   1931        New Brighton       20                 4    22
## 2        3a   1931            Rochdale       21                 4    22
## 3         2   2003       Bradford City       23                 3    24
## 4         2   2005    Sheffield United        2                 3    24
## 5        3a   1931        New Brighton       20                 3    22
## 6        3a   1931            Rochdale       21                 3    22
## 7        3b   1929           Brentford        2                 3    22
## 8         4   1975    Northampton Town        2                 3    24
## 9         1   1888         Aston Villa        2                 2    12
## 10        1   1930         Aston Villa        2                 2    22
## 11        1   1934          Sunderland        2                 2    22
## 12        1   1946           Brentford       21                 2    22
## 13        1   1957   Preston North End        2                 2    22
## 14        1   1970             Burnley       21                 2    22
## 15        1   1978 Queens Park Rangers       20                 2    22</code></pre>
<p>Which really emphasises how only exceptionally good/bad teams are ever really certain of their position before the end of the season.</p>
</div>
<div id="draw-me-like-one-of-your-top-flight-teams" class="section level1">
<h1>Draw Me Like One of Your Top Flight Teams</h1>
<p><a href="https://www.theguardian.com/football/2019/feb/06/what-are-the-lowest-xg-scoring-football-matches-in-history-expected-goals-the-knowledge-football">““Tottenham have currently played 29 consecutive Premier League games without drawing one,” notes Wouter van Dael. “What is the longest ever such league run?””</a></p>
<p>To do this we just need to select every game with a non-zero goal difference (i.e. a draw) and then find consecutive runs for teams.</p>
<pre class="r"><code>draws &lt;- eng_data %&gt;%
  setDT() %&gt;%
  .[order(team, date)] %&gt;%
  #give each match a consecutive &#39;id&#39;
  .[, game_id := 1:.N, by = team] %&gt;%
  #find matches with a non zero goal difference (not a draw)
  .[goal_diff != 0] %&gt;%
  #find consecutive matches with non zero goal difference
  .[, consecutive := lead(game_id) - game_id, by = team] %&gt;%
  .[consecutive != 1, consecutive := NA] %&gt;%
  #count all consecutive runs
  .[, count := .N*!is.na(consecutive), rleid(!is.na(consecutive))] %&gt;%
  #find the start and end of each run
  .[count != lead(count) | count != lag(count)] %&gt;%
  .[order(-count, team, date)] %&gt;%
  #set the start points and end point and spread to separate columns
  .[, run_point := c(&quot;start&quot;, &quot;end&quot;)] %&gt;%
  spread(run_point, date) %&gt;%
  .[, start := na.locf(start)] %&gt;%
  .[!is.na(end) &amp; !is.na(start)] %&gt;%
  #select columns to print
  .[, c(&quot;start&quot;, &quot;end&quot;, &quot;division&quot;, &quot;team&quot;, &quot;count&quot;)] %&gt;%
  .[order(-count)]

head(data.frame(draws), 25)</code></pre>
<pre><code>##         start        end division                    team count
## 1  1891-01-01 1892-12-10        1             Aston Villa    50
## 2  1895-03-30 1896-11-09        1              Stoke City    45
## 3  1907-12-26 1909-02-27        1              Sunderland    45
## 4  1913-01-01 1914-02-14        2    Bradford Park Avenue    43
## 5  1909-01-30 1910-03-25        2          Leicester City    43
## 6  1894-01-06 1896-09-05        2                 Walsall    43
## 7  1892-12-10 1894-09-15        1         Birmingham City    42
## 8  1896-03-21 1897-09-25        2                  Darwen    39
## 9  1928-03-17 1929-02-02        1              Portsmouth    37
## 10 1904-10-22 1905-11-11        1        Sheffield United    37
## 11 1947-11-15 1948-09-25       3b          Bristol Rovers    36
## 12 1930-05-03 1931-03-28        2 Wolverhampton Wanderers    36
## 13 1894-03-23 1895-04-20        2            Lincoln City    35
## 14 1946-10-12 1947-08-23       3a        Stockport County    35
## 15 1904-01-30 1904-12-27        2            Bristol City    34
## 16 1915-04-03 1920-02-21        1    West Bromwich Albion    34
## 17 1934-12-01 1935-09-16        2        Doncaster Rovers    33
## 18 1895-11-16 1896-11-28        2        Newcastle United    33
## 19 1925-05-02 1926-02-22        2           Middlesbrough    32
## 20 1935-08-31 1936-03-14       3b                 Reading    32
## 21 1925-12-26 1926-10-02       3a                Rochdale    32
## 22 1896-01-20 1897-02-13        2        Burton Wanderers    31
## 23 1927-12-24 1928-09-15       3a      Accrington Stanley    30
## 24 1905-11-04 1906-09-03        2    Gainsborough Trinity    30
## 25 1946-11-23 1947-08-25        2         Plymouth Argyle    30</code></pre>
<p>Tottenham’s run without a draw doesn’t even make the top 25 such runs! ANd they still would have to wait until at least next season until they can match Aston Villa’s run from New Years Day 1891 until Christmas Eve in 1892, a run of 50 matches without a draw- a run that included 23 losses, and 27 wins. It is the longest for quite sometime though- there’s few similar runs in the post-war years.</p>
<p>We can restrict this easily to just runs in the top division my modifying one line</p>
<pre class="r"><code>draws &lt;- eng_data %&gt;%
  setDT() %&gt;%
  .[order(team, date)] %&gt;%
  .[, game_id := 1:.N, by = team] %&gt;%
  #filter out only the top division matches
  .[division == 1] %&gt;%
  .[goal_diff != 0] %&gt;%
  .[, consecutive := lead(game_id) - game_id, by = team] %&gt;%
  .[consecutive != 1, consecutive := NA] %&gt;%
  .[, count := .N*!is.na(consecutive), rleid(!is.na(consecutive))] %&gt;%
  .[count != lead(count) | count != lag(count)] %&gt;%
  .[order(-count, team, date)] %&gt;%
  .[, run_point := c(&quot;start&quot;, &quot;end&quot;)] %&gt;%
  spread(run_point, date) %&gt;%
  .[, start := na.locf(start)] %&gt;%
  .[!is.na(end) &amp; !is.na(start)] %&gt;%
  .[, c(&quot;start&quot;, &quot;end&quot;, &quot;division&quot;, &quot;team&quot;, &quot;count&quot;)] %&gt;%
  .[order(-count)]

head(data.frame(draws), 10)</code></pre>
<pre><code>##         start        end division                    team count
## 1  1891-01-01 1892-12-10        1             Aston Villa    50
## 2  1895-03-30 1896-11-09        1              Stoke City    45
## 3  1907-12-26 1909-02-27        1              Sunderland    45
## 4  1928-03-17 1929-02-02        1              Portsmouth    37
## 5  1904-10-22 1905-11-11        1        Sheffield United    37
## 6  1915-04-03 1920-02-21        1    West Bromwich Albion    34
## 7  1895-09-28 1896-09-12        1 Wolverhampton Wanderers    29
## 8  1964-09-12 1965-03-31        1             Aston Villa    28
## 9  1953-04-25 1954-01-02        1                 Burnley    28
## 10 1891-03-14 1892-04-30        1              Sunderland    28</code></pre>
<p>Where we can see that Spurs’ run is at least the longest modern top flight drawless run.</p>
</div>
