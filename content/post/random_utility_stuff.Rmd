---
title: RANDOM UTILITY MODELS DRAFT
author: Robert Hickman
date: '2019-04-24'
slug: rum_draft
output: pdf_document
categories: []
tags:
  - economics
  - behaviour
header:
  caption: ''
  image: ''
---

load up tidyverse for some verbose data munging

```{r libraries, warning=FALSE,message=FALSE}
library(tidyverse)
```

load in the data (Vicer bundle choice data from March)

```{r load_data, warning=FALSE,message=FALSE}
data <- dir("C:/Users/robwh/Desktop/rum_data") %>%
  #load in all .csvs
  #trial by trial results
  .[grepl("\\.csv$", .)] %>%
  file.path("C:/Users/robwh/Desktop/rum_data", .) %>%
  lapply(., read.csv, stringsAsFactors = FALSE) %>%
  #bind data together
  map_df(I)

table(data$date)
```

We have data from 3 separate days, but I'm just going to pool them together for larger n

Plot the data in the standard bundle choice logistic regression format

```{r plot_bundle_choices, warning=FALSE,message=FALSE}
bcb_data <- data %>%
  #only want data pertaining to bundle choice task
  filter(subtask == "bundle_choice") %>%
  #select only interesting variables
  mutate(bundle_water_ml = second_budget_value * budget_magnitude,
         non_bundle_water_ml = budget_value * budget_magnitude) %>%
  select(bundle_water_ml, non_bundle_water_ml, juice_ml = reward_magnitude, results) %>%
  #binary yes/no for choosing the bundle or not
  mutate(bundle_chosen = case_when(
    grepl("fractal_chosen", results) ~ 1,
    grepl("budget_chosen", results) ~ 0
  )) %>%
  #remove trials where neither is chosen
  #i.e. errors
  filter(!is.na(bundle_chosen))
  
#nice quick function for plotting a logistic regression curve
binomial_smooth <- function(...) {
  geom_smooth(method = "glm", method.args = list(family = "binomial"), ...)
}

p <- bcb_data %>%
  #group data by bundle combinations of reward and water
  group_by(juice_ml, bundle_water_ml) %>%
  #what fraction of the time is the bundle chosen
  summarise(fraction_bundle_choice = mean(bundle_chosen)) %>%
  #pipe into a plot
  ggplot(., aes(x = bundle_water_ml, y = fraction_bundle_choice, colour = factor(juice_ml))) +
  #plot the likelihood of choosing the bundle for each juice/water combination
  geom_point() +
  #add in the logistic fit line
  #n.b. se is calculated per point so is massive
  binomial_smooth(se = FALSE) +
  #add in the colour scale
  scale_colour_manual(values = c("red", "blue", "green"), 
                      name = "reward juice (/ml)") +
  #add in some labels
  labs(title = "Bundle Choice Logistic Regression",
       subtitle = "data from Vicer on bundle choice task in March",
       x = "bundle water (/ml)",
       y = "% chooses bundle") +
  #remove extra stuff
  theme_minimal()

#plot it
p

```

$$p(A) = \frac{1}{1+e^{-\theta(u(A_{i}) - u(B_{i}))}}$$ 

$$LL(\theta,y) = \sum_{i=1}^{I} y_{i}\log(p(A)) + (1-y_{i})\log(1-p(A))$$ 

where

$$Max_{\theta}L(\theta|y)$$

transform the data into a simple binary choice paradigm between and amount of juice and an amount of water (obviously only for toy example and not serious as removes interaction effects)

```{r transform_to_BC, warning=FALSE,message=FALSE}
binary_choice_model <- bcb_data %>%
  #water choice is the difference in water between full water amount and bundle water
  mutate(water_ml = (non_bundle_water_ml- bundle_water_ml)) %>%
  select(juice_ml, water_ml, juice_chosen = bundle_chosen)

head(binary_choice_model)

```
plotting this gives

```{r plot_bc, warning=FALSE,message=FALSE}
p <- binary_choice_model %>%
  #group data by bundle combinations of reward and water
  group_by(juice_ml, water_ml) %>%
  #what fraction of the time is the bundle chosen
  summarise(fraction_juice_choice = mean(juice_chosen)) %>%
  #pipe into a plot
  ggplot(., aes(x = water_ml, y = fraction_juice_choice, colour = factor(juice_ml))) +
  #plot the likelihood of choosing the bundle for each juice/water combination
  geom_point() +
  #add in the logistic fit line
  #n.b. se is calculated per point so is massive
  binomial_smooth(se = FALSE) +
  #add in the colour scale
  scale_colour_manual(values = c("red", "blue", "green"), 
                      name = "juice (/ml)") +
  #add in some labels
  labs(title = "Binary Choice Logistic Regression",
       subtitle = "data from Vicer on bundle choice task in March",
       x = "water (/ml)",
       y = "% chooses juice") +
  #remove extra stuff
  theme_minimal()

#plot it
p

```



For a choice between juice and water with a utility function (rho_juice and rho_water) where we assume the utility of juice > utility of water, with a softmax temperature of theta

```{r max_likelihood, warning=FALSE,message=FALSE}
parameters <- c(1, 1, 1)
names(parameters) <- c("rho_juice", "rho_water", "theta")

total_utility <- function(parameters, data) {
  theta <- parameters["theta"]
  j_rho <- parameters["rho_juice"]
  w_rho <- parameters["rho_water"]
  
  trial_j_utility <- data$juice_ml * j_rho
  trial_w_utility <- data$water_ml * w_rho
  delta_utility <- trial_j_utility - trial_w_utility
  
  p_a <- 1 / (1 + exp(-theta*delta_utility))
  
  log_lik <- (data$juice_chosen * log(p_a)) + ((1-data$juice_chosen) * log(1-p_a))
  
  return(sum(log_lik))
}

optim_params <- stats::optim(par = parameters,
                             fn = total_utility,
                             data = binary_choice_model,
                             method = "Nelder-Mead",
                             control = list(fnscale = -1))

optim_params$par
```
