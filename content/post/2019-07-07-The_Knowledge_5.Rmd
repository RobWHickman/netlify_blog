---
output:
  pdf_document: default
  html_document: default
---
title: "The Guardian Knowledge July 2019"
author: "Robert Hickman"
date: '2019-07-07'
output:
  html_document:
    df_print: paged
header:
  caption: ''
  image: ''
slug: guardian_knowledge_july
tags:
- rstats
- football
- the_knowledge
categories: []
---

```{r libraries, warning=FALSE,message=FALSE}
library(tidyverse)
library(broom)
library(engsoccerdata)
```

```{r load_leagues, warning=FALSE,message=FALSE}
league_data <- engsoccerdata::england %>%
  select(season = Season, division, home, visitor, hgoal, vgoal) %>%
  gather("location", "team", -season, -division, -hgoal, -vgoal) %>%
  mutate(
    g_for = case_when(
      location == "home" ~ hgoal,
      location == "visitor" ~ vgoal
    ),
    g_ag = case_when(
      location == "home" ~ vgoal,
      location == "visitor" ~ hgoal
    )) %>%
  mutate(
    points = case_when(
      g_for > g_ag & season < 1981 ~ 2,
      g_for > g_ag & season > 1980 ~ 3,
      g_for == g_ag ~ 1,
      g_for < g_ag ~ 0
    ),
    gd = g_for - g_ag
  ) %>%
  group_by(season, division, team) %>%
  summarise(points = sum(points),
            gd = sum(gd),
            g_for = sum(g_for)) %>%
  arrange(-points, -gd, -g_for) %>%
  mutate(league_pos = rank(-points, ties.method = "first"),
         alph_order = rank(team, ties.method = "first")) %>%
  select(season, division, team, league_pos, alph_order) %>%
  split(., f = list(.$season, .$division)) %>%
  keep(function(x) nrow(x) > 0)
  

```


```{r find_correlations, warning=FALSE,message=FALSE}
correlations <- league_data %>%
  map_df(., function(data) {
    cor.test(
      data$league_pos,
      data$alph_order,
      method = "spearman"
    ) %>%
      tidy() %>%
      mutate(season = unique(data$season),
             division = unique(data$division))
  }) %>%
  filter(p.value < 0.05)
```

Let's imagine a very small league (say 8 teams). 

```{r get_6_teams, warning=FALSE,message=FALSE}
first_letter_names <- league_data %>%
  bind_rows() %>%
  ungroup() %>%
  mutate(first_letter = gsub("(^.)(.*)", "\\1", team)) %>%
  filter(season > 1992 &
           division == 1 &
           first_letter %in% toupper(letters[1:6])
         ) %>%
  filter(!duplicated(first_letter)) %>%
  select(team) %>%
  arrange(team) %>%
  print()

```

So for the league to finish in alphabetical order, we first need the team that is first alphabetically (Arsenal) to finish in first position. Assuming all teams have an equal chance of winning the league, the chance of this is obviously

$$ p(Arsenal = 1) =  \frac{1}{n}$$

Then we need the second team (Blackburn Rovers), to finish in second. This is predicated on Arsenal already finishing in first position, so the chance becomes

$$ p(Blackburn = 2 | Arsenal = 1) = \frac{1}{n-1} $$

and so on until the last team (Fulham) just have to slot into the only position left (n, 6th in our example)

Thus the total chance becomes

$$ \frac{1}{n} \cdot \frac{1}{n-1} ... \cdot \frac{1}{1} $$

which can also be written

$$ p(ordered) = \prod_{n = 1}^{N} \frac{1}{n}$$

which multiplies out to

$$ p(ordered) = \frac{1}{n!} $$

so for our very small league the chance of n (assumed equally strong teams) 

```{r get_minileague_chance, warning=FALSE,message=FALSE}
factorial(nrow(first_letter_names))
```

so we have a 1/720 chance that this league ends perfectly in alphabetical order. For bigger leagues (for reference most large European leagues contain 18-24 teams) this number _super-exponentially_ and is tiny.

For the English Premier League (20 teams) for instance the chance becomes

```{r calculate_epl_chance, warning=FALSE,message=FALSE}
league_data %>%
  bind_rows() %>%
  ungroup() %>%
  filter(season == max(season) & division == 1) %>% 
  nrow() %>%
  factorial()
```
or 1 in 2.4 [quintillion](https://en.wikipedia.org/wiki/Order_of_magnitude). In short, if it's assumed that there's no relation between order of names and team strength, we might expect the universe to end before all 20 teams finish in perfect order.

We can test if our predictions bear out by looking at tiny leagues with small numbers of teams, e.g. [the group stages of the Champions/Europa Leagues](https://en.wikipedia.org/wiki/2018%E2%80%9319_UEFA_Champions_League_group_stage).

```{r get_uefa_data, warning=FALSE,message=FALSE}
library(rvest)

fb_data <- "https://footballdatabase.com"
ucl_links <- sprintf("/league-scores-tables/uefa-champions-league-20%s-%s", 10:18, 11:19)
europa_links <- sprintf("/league-scores-tables/uefa-europa-league-20%s-%s", 10:18, 11:19)

get_competition_data <- function(competition, links) {
  data <- links %>%
    paste0(fb_data, .) %>%
    map_df(., function(year) {
      page_read <- read_html(year)
      
      groups <- letters[1:8] %>%
        map_df(., function(group) {
          page_read %>% 
            html_nodes(sprintf("#total-group-%s > div > table", group)) %>% 
            html_table(fill = TRUE) %>% 
            as.data.frame() %>%
            mutate(group)
        }) %>%
        mutate(year = gsub("(.*-)([0-9]{4}-[0-9]{2})", "\\2", year))
    }) %>%
    mutate(competition)
}

uefa_data <- bind_rows(
  get_competition_data("champions", ucl_links),
  get_competition_data("europa", europa_links)
)

head(uefa_data)
  
```

```{r get_ordered_groups, warning=FALSE,message=FALSE}
ordered_groups <- uefa_data %>%
  select(team = Club, league_pos = X., group, year, competition) %>%
  group_by(year, group, competition) %>%
  mutate(alph_order = rank(team, ties.method = "first")) %>%
  filter(league_pos == alph_order) %>%
  summarise(n = n()) %>%
  filter(n == 4) %>%
  left_join(uefa_data, ., by = c("group", "year", "competition")) %>%
  filter(!is.na(n)) %>%
  select(team = Club, points = P, gd = X..., league_pos = X., group, year, competition) %>%
  split(., list(.$year, .$group, .$competition)) %>%
  keep(function(x) nrow(x) > 0)

```

```{r uefa_chance, warning=FALSE,message=FALSE}
unique_leagues <- uefa_data %>%
  mutate(id = paste(.$group, .$year, .$competition)) %>%
  filter(!duplicated(id)) %>%
  nrow()
```



```{r all_leagues_data, warning=FALSE,message=FALSE}
sample_cutdown_leagues <- function(teams, samples, data) {
  samples <- sample(length(data), samples, replace = TRUE)
  
  sampled_league_data <- data[samples]
  i <<- sampled_league_data
  tests <- lapply(sampled_league_data, function(data) {
    teams <- sample(nrow(data), teams)
    team_finishes <- data[teams,]
    test <- cor.test(
      team_finishes$league_pos,
      team_finishes$alph_order,
      method = "spearman"
    ) %>%
      tidy() %>%
      mutate(teams = paste(data$team[teams], collapse = ", "))
  })
}

x <- sample_cutdown_leagues(6, 100000, league_data) %>%
  map_df(.f = bind_rows, .id = "league")
 
```

