---
title: "The Knowledge 4th August 2018"
author: "Robert Hickman"
date: '2018-08-04'
output: pdf_document
header:
  caption: ''
  image: ''
slug: the-knowledge-4th-august-2018
tags:
- rstats
- football
- the_knowledge
categories: []
---

The Guardian publish a weekly set of questions and answers on a variety of football minutiae at [The Knowledge](https://www.theguardian.com/football/series/theknowledge). Forutnately, some of these are extremely tractable using R, so I thought I'd have a go at working through the archives to see if I can shed light on any of the questions.

```{r libraries, message=FALSE,warning=FALSE}
library(rvest)
library(dplyr)
library(magrittr)
library(data.table)
library(zoo)
library(ggplot2)
library(rvest)
library(stringr)

#jalapic/engsoccerdata
library(engsoccerdata)
```


#We Ain't Going To The Town..

['This season, Tranmere Rovers return to contest League Two alongside eight teams with the suffix Town, including six successive fixtures against these clubs over the New Year. What is the record for successive fixtures versus clubs with the same (or no) prefix or suffix?'](https://twitter.com/topes_lose/status/1023537060668473344?ref_src=twsrc%5Etfw%7Ctwcamp%5Etweetembed%7Ctwterm%5E1023537060668473344&ref_url=https%3A%2F%2Fwww.theguardian.com%2Ffootball%2F2018%2Faug%2F01%2Ffootballers-who-have-backed-out-of-a-transfer-for-another-late-in-the-day)

For this question I decided to ignore prefixes as the dataset I'm using doesn't have any that could be matches between teams except the 'West' in West Ham and West Bromwich Albion. That dataset is the excellent engsoccerdata from James Curley found at his github [here](https://github.com/jalapic/engsoccerdata) and on CRAN.


```{r, message=FALSE,warning=FALSE}
#take all of the english soccer data in the package and bind it together
england_data <- bind_rows(
    select(engsoccerdata::england,
           .data$home, .data$visitor, date = .data$Date),
    select(engsoccerdata::englandplayoffs,
           .data$home, .data$visitor, date = .data$Date),
    select(engsoccerdata::england1939,
           .data$home, .data$visitor, date = .data$Date)) %>%
  setDT() %>%
  #convert the date to date class
  .[, date := as.Date(date)]

#get a list of each unique team in the dataset
all_teams <- unique(c(as.character(england_data$home),
                      as.character(england_data$visitor)))

#melt the dataset by each teams matches
find_chains <- rbindlist(lapply(all_teams, function(team) {
  england_data %>%
    .[home == team | visitor == team] %>%
    .[, matching_team := team]
  })) %>%
  .[home == matching_team, other := visitor] %>%
  .[visitor == matching_team, other := home] %>%
  .[, c("date", "matching_team", "other")] %>%
  #get the suffixes and prefixes of the other team
  .[, other_prefix := gsub(" .*", "", other)] %>%
  .[, other_suffix := gsub(".* ", "", other)] %>%
  #arrange by team and date
  .[order(matching_team, date)] %>%
  #convert to an id
  .[, suffix_id := as.numeric(as.factor(other_suffix))] %>%
  #if playing consecutively against the same suffix id (ignoring prefixes for now) put in same 'chain'
  .[, match := suffix_id - lead(suffix_id), by = "matching_team"] %>%
  .[match == 0 & lead(match) != 0, chain_id := 1:.N] %>%
  .[match == 0] %>%
  .[, chain_id := na.locf(chain_id, fromLast = TRUE)] %>%
  .[, chain_length := .N, by = chain_id] %>%
  #take only chains at least as long as Tranmere's run (6)
  .[chain_length > 5] %>%
  .[order(chain_length)] %>%
  .[, c("date", "matching_team", "other", "chain_length")]

#print the chains of equal length to Tranmere's run
print(find_chains)
```

so In fact an identical length chain on matching suffixes has occured twice, with Chesterfield playing a range of cities at the start of 1951 in League Two, and much more recently, Leicester playing 6 different Uniteds in a row at the tail end of the 2008/2009 season. This is also the season that saw them recover from being relegated from the Chmapionship and start moving towards winning the title in 2015-2016 season.

Some longer chains involving cities happened in the 1920-1921 seasons in the Second Division, but it seems like the schedulnig worked differently then so doesn't really count.

Having originally misread the question, I also wanted to find out the longest chain of a team playing teams that matched _their own_ suffix. We can do this using a similar method

```{r, warning=FALSE,message=FALSE}
matching_fixtures <- england_data %>%
  #get only matches between teams with matching prefix/suffixes
  .[, home_suffix := gsub(".* ", "", home)] %>%
  .[, away_suffix := gsub(".* ", "", visitor)] %>%
  .[home_suffix == away_suffix, match := home_suffix] %>%
  .[!is.na(match)] %>%
  #remove matches where teams from the same city play each other
  .[!match %in% c("Bradford", "Bristol", "Burton", "Manchester", "Sheffield")]

#get all the teams that have played teams with matching suffixes
matching_teams <- unique(c(as.character(matching_fixtures$home),
                           as.character(matching_fixtures$visitor)))

#elongate the data and look for chains
find_chains <- rbindlist(lapply(matching_teams, function(team) {
  england_data %>%
    .[home == team | visitor == team] %>%
    .[order(date)] %>%
    .[, matching_team := team]
  })) %>%
  .[home == matching_team, other := visitor] %>%
  .[visitor == matching_team, other := home] %>%
  #id matches and remove matches not involving teams with identical suffixes
  .[, match_id := 1:.N, by = matching_team] %>%
  .[!is.na(match)] %>%
  #find chains of identical suffixed matches
  .[, chain := match_id - lag(match_id)] %>%
  .[chain == 1 & lag(chain) != 1, chain_id := 1:.N] %>%
  .[chain == 1] %>%
  .[, chain_id := na.locf(chain_id)] %>%
    .[, chain_length := .N, by = chain_id] %>%
  #take only chains at least as long as Tranmere's run (6)
  .[chain_length > 4] %>%
  .[order(chain_length)] %>%
  .[, c("date", "matching_team", "other", "chain_length")]

print(find_chains)
```

So the record for that is only slightly shorter! with Stoke and Hull City playing a range of cities in the 1919-1920 season (but see above for scheduling differences?) and Carlisle United playing 5 other different Uniteds in a row in the old Fourth Division.

#Youth Of The Nation

[“If Lucas Hernández was born a year and a half later, his age would be a lower than his shirt number (21). Have any World Cup winners achieved this?” muses Edward Gibson.](https://www.theguardian.com/football/2018/aug/01/footballers-who-have-backed-out-of-a-transfer-for-another-late-in-the-day)

The easiest way to check this is just to scrape all of the squads off of the wiki pages for the World Cups. I only did from 1954 onwards as before this the squad no and birthdate data is a bit patchy.

```{r}
#links to the world cup squads pages
wiki_cup_squads <- sprintf("https://en.wikipedia.org/wiki/%s_FIFA_World_Cup_squads",
                           seq(1954, 2018, by = 4))

#scrape all the player data we need
world_cup_squads <- rbindlist(lapply(wiki_cup_squads[1:17], function(link) {
  year <- gsub(".*\\/wiki\\/", "", gsub("_FIFA_World.*", "", link))
  read <- read_html(link)
  
  sq_no <- read %>% 
    html_nodes(".plainrowheaders td:nth-child(1)") %>%
    html_text() %>%
    as.numeric()
  sq_names <- read %>%
    html_nodes(".plainrowheaders a:nth-child(1)") %>% 
    html_text() %>%
    .[. != ""] %>%
    .[!grepl("^\\[", .)] %>%
    .[. != "Unattached"] %>% 
    .[!grepl("captain", .)]
  sq_dobs <- read %>% 
    html_nodes(".plainrowheaders td:nth-child(4)") %>%
    html_text() %>%
    str_extract(., "[0-9]{4}-[0-9]{2}-[0-9]{2}") %>% 
    as.Date()
  countries <- read %>% html_nodes("h3 .mw-headline") %>% 
    html_text() %>% 
    trimws()

  if(year > 2006) countries <- countries[1:32]
  
  squad_data <- data.frame(name = sq_names,
                           no = sq_no,
                           dob = sq_dobs,
                           year= year) %>%
    setDT() %>%
    .[!grepl("Nery Pumpido", name)] %>%
    .[no == 1, country := countries] %>%
    .[, country := na.locf(country)] %>%
    .[, c("name", "no", "dob", "year", "country")]
}))

#find all world cup squad players with shirt numbers greater than their age in years
young_players <- world_cup_squads %>%
  .[, age := as.numeric(difftime(as.Date(paste0(year, "-07-01")), dob)) / 365] %>%
  .[age < no]

print(young_players)
```

Overall 114 players are found. England actually have the most players with shirt numbers higher than their age with 9: Haynes, Hooper, Owen, Ferdinand, Carson, Walcott, Barkeley, Shaw, Alexander-Arnold. Surprisingly, most of these are pretty recent.

```{r}
p <- ggplot(data = young_players, aes(year)) +
  geom_bar() +
  ggtitle("Number of Players in World Cup Squads With Nos > Age") +
  xlab("World Cup Year") +
  ylab("Number")

print(p)
```

It seems that the real high point for this was the turn of the century with young players being given a shot at the tail end of squads, which is returning to pre-1998 levels by 2018.

The data on these squad players is then merged with the data on the winning teams to find those who played for nations who went on to winthe world cup.

```{r}
wc_winners <- data.frame(winner = c("West Germany","Brazil","Brazil","England","Brazil",
                                    "West Germany","Argentina","Italy","Argentina","West Germany",
                                    "Brazil","France","Brazil","Italy","Spain","Germany","France"),
                         year = seq(1954, 2018, 4))

#merge data with winners and find matches
young_players %<>% .[, year := as.numeric(as.character(year))] %>%
  .[, country := gsub("(^\\s+)|(\\s+$)", "", country)] %>%
  merge(., wc_winners, by = "year") %>%
  .[winner == country]

#kaka only one to have played as per https://en.wikipedia.org/wiki/List_of_FIFA_World_Cup_winners#By_year
print(young_players)
```

So only the great [Émerson Leão](https://en.wikipedia.org/wiki/%C3%89merson_Le%C3%A3o), [Ronaldo](https://en.wikipedia.org/wiki/Ronaldo_(Brazilian_footballer)) and [Kaka](https://en.wikipedia.org/wiki/Kak%C3%A1) satisfy the question. However, of these only Kaka played any part during the tournament, which only amounted to 25 minutes vs Costa Rica.
