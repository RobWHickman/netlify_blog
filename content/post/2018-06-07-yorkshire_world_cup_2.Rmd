---
title: "Could an Independent Yorkshire Win the World Cup - LASSOs and Player Positions"
author: "Robert Hickman"
date: '2018-06-06'
output: pdf_document
header:
  caption: ''
  image: ''
slug: yorkshire_world_cup_2
tags:
- rstats
- world cup
- football
categories: []
---

Recently, a Yorkshire national football team [appeared in a league of national teams for stateless people](https://www.theguardian.com/uk-news/2018/jan/28/yorkshire-football-team-makes-debut-in-world-league-of-stateless-peoples). This got me wondering how the historic counties of the UK would do at the world cup. Could any of them compete with full international teams?

This is the complete script for an short article I wrote for [CityMetric](https://www.citymetric.com/horizons/football-could-independent-yorkshire-win-world-cup-3961) on the topic. It's split over 6 separate parts and is pretty hefty but contains pretty much everything you need to clone the article. Last time, we got the shapefiles for the historic counties of the UK and scraped the player data we'll use to build the teams

```{r libraries, warning=FALSE,message=FALSE}
library(dplyr)
library(magrittr)
library(data.table)
library(ggplot2)
#we'll use glmnet to do LASSO regression to determine players positional ability
library(glmnet)
```

#Work Out Player Position Ability

The data we've scraped only gives a player's overall 'ability' and their abilities on specific skills (e.g. strength, long shots, dribbling...). We want to use this to work out how good each player is at each position.

It's logical to assume that a player's overall ability is how good they are at their main position (the position listed first on their page on fifaindex.com). We can therefore use [LASSO regression](https://en.wikipedia.org/wiki/Lasso_(statistics)) to work out which stats are contributing to their overall ability score. For instance, we would expect that a goalkeepers overall ability score is just a function of gk_positioning, gk_diving, gk_handling and so on... and doesn't care about (e.g.) dribbling.

This positional ability score is important as we can't just select the 11 best players for each team as we might end up playing a goalkeeper and 10 defenders (or etc.). We need to make sure we select the best palyers for each position on a realistic formation.

Unfortunately, there's going to be no real way to tell between a players ability to play on either side of the field. There's some correlation with their footedness ($foot), but it's not worth going too in the weeds about that. So first we want to make all position symmetrical (i.e. we do discriminate between left and right sided positions).


```{r load_scraped_player_data, warning=FALSE,message=FALSE,echo=FALSE}
#load the scraped player data to save running the entire scraping procedure
#saveRDS(all_players_data, "all_player_data.rds")
all_players_data <- readRDS("C:/Users/Robert/Desktop/New Coding/March 2018 UK World Cup/all_player_data.rds")
```

```{r mirror_positions, warning=FALSE,message=FALSE}
all_players_data %<>% mutate(symmetric_position = gsub("L|R", "W", main_position))

unique(as.character(all_players_data$main_position))
unique(all_players_data$symmetric_position)

```

First we need to convert the stats that we're going to use for this regression/prediction into matrix form

```{r prepare_LASSO_data, warning=FALSE,message=FALSE}
player_stats <- all_players_data %>%
  #select only the players stats for each skill
  select(c(12, 14:47)) %>%
  #transition data into matrix
  model.matrix(overall~., .)

#show the first 6 instances of the first 5 stats
head(player_stats[,c(1:5)])
```
To show how this works I'm going to illustrate it using goalkeepers and predicting the ability of each outfield player to play in goal.

```{r example_LASSO, warning=FALSE,message=FALSE}
#filter out only the goalkeepers
goalkeepers <- all_players_data %>%
  filter(symmetric_position == "GK")

#select a percentage of these to use as training data
sample_percent <- 10
train_samples <- sample(1:nrow(goalkeepers), (nrow(goalkeepers)/100)*sample_percent)

gk_stats <- goalkeepers %>%
  slice(train_samples) %>%
  select(c(12, 14:47))

#get the stats per skill
train_matrix <- model.matrix(overall~., gk_stats)
#and the overall (gk) ability
train_ability <- gk_stats$overall
  
#perform the regression
cv_model <- cv.glmnet(train_matrix, train_ability)

#look at the weightings given to important variables using lambda value that gives minimum mean cross-validated error
coef(cv_model, s = "lambda.min")

```

The regression selects only variables which have a strong relationship with the outcome (overall ability in the gk position in this case). As expected, it selects only the gk_... skillset and also a players reactions, which makes sense if goalkeepers have to make point blank saves.

We can validate this by predicting the overall ability of the goalkeepers that aren't in the training set fairly simply

```{r example_LASSO_validation, warning=FALSE,message=FALSE}
#find non training examples of goalkeepers
test_matrix <- goalkeepers %>%
  slice(-train_samples) %>%
  select(c(12, 14:47)) %>%
  model.matrix(overall~., .)

#get the overall ability for these players
gk_abilities <- goalkeepers %>%
  slice(-train_samples) %>%
  select(overall)

#predict their overall ability based on their stats
gk_abilities$predicted <- as.vector(predict(cv_model, newx = test_matrix, s = "lambda.min", type="response"))

#plot these
p <- ggplot(data = gk_abilities, aes(x = overall, y = predicted)) +
  geom_point() +
  xlab("Overall FIFA Ability") +
  ylab("Predicted FIFA Ability") +
  ggtitle("Actual and Predicted Goalkeeping Ability of Goalkeepers in FIFA18")

plot(p)
```

Which gives a very good fit. This is expected for the dataset we're using as the overall ability hasbeen directly calclulated from the complete set of skills using some hidden algorithm. In the real world, the actual vs. predicted results would most likely have more noise.

We can use this model now to predict how well outfield players would fare in goal, given that they have (low) ratings for all of these skills

```{r example_LASSO_prediction, warning=FALSE,message=FALSE}
#find all outfield players and convert stats the matrix
outfield_players <- all_players_data %>%
  filter(symmetric_position != "GK") %>%
  select(c(12, 14:47)) %>%
  model.matrix(overall~., .)

#get the names of each outfield palyer
outfield_goalkeepers <- all_players_data %>%
  filter(symmetric_position != "GK") %>%
  select(name)

#predict how well each outfield player would do in goal
outfield_goalkeepers$predicted_ability <- as.vector(predict(cv_model, newx = outfield_players, s = "lambda.min", type="response"))

head(outfield_goalkeepers)

```

It is of course, extremely ironic that Luis Suarez scores relatively highly as an outfield player in goal [given his history](https://www.youtube.com/watch?v=wn_oYeugGiw).

We can use this technique to predict how each player would play in each position using the following function

```{r get_position_abilities, warning=FALSE,message=FALSE}
#function to predict how each player would play in each position
get_position_weights <- function(position, sample_percent) {
  #filter data
  position_df <- all_players_data %>%
    filter(symmetric_position == position)
  
  #get training data
  train_samples <- sample(1:nrow(position_df), (nrow(position_df)/100)*sample_percent)
  
  train_stats <- position_df %>%
    .[train_samples,] %>%
    select(c(12, 14:47))
  
  train_matrix <- model.matrix(overall~., train_stats)
  
  train_ability <- train_stats$overall
  
  #use LASSO regression to find weighting of significant covariates
  cv_model <- cv.glmnet(train_matrix, train_ability)
  
  #predict players ability in that position
  position_ability <- predict(cv_model, newx = player_stats, s = "lambda.min", type="response")
}

#run through every mirrored position
#using a high percentage of palyers in training set (50%) as in theory should be perfect regression
position_abilities <- lapply(unique(all_players_data$symmetric_position), 
                             get_position_weights, sample_percent = 50) %>%
  do.call(cbind, .) %>%
  data.frame()

#name each position
names(position_abilities) <- unique(all_players_data$symmetric_position)

#bind this to the data we have on all the players
all_players_data <- cbind(all_players_data, position_abilities) %>%
  #convert all non-natural goalkeepers goalkeeping ability to zero
  #want to make sure no non-goalkeepers are chosen in goal
  mutate(GK = ifelse(main_position == "GK", overall, 0)) 

#show the first 6 rows
head(select(all_players_data, c(1, 49:60)))

```

Now we have the ability of each player to perform in any position we can use it to build teams. First however, we need to sort British players into the county of their birth, which we'll do in the next post.
