---
title: "Could an Independent Yorkshire Win the World Cup - Rest of the World/UK"
author: "Robert Hickman"
date: '2018-06-10'
output: pdf_document
header:
  caption: ''
  image: ''
slug: yorkshire_world_cup_6
tags:
- rstats
- world cup
- football
categories: []
---

Recently, a Yorkshire national football team [appeared in a league of national teams for stateless people](https://www.theguardian.com/uk-news/2018/jan/28/yorkshire-football-team-makes-debut-in-world-league-of-stateless-peoples). This got me wondering how the historic counties of the UK would do at the world cup. Could any of them compete with full international teams?

I [published](http://www.robert-hickman.eu/post/yorkshire_world_cup_1/) the complete code for that article on this blog this week. However, one question which I kept being asked was how a 'All of the UK' team would do (i.e. if the country wasn't split up into England, Wales, Scotland, and Northern Ireland). Listening to the latest [Double Pivot Podcast](https://twitter.com/doublepivotpod?lang=en), drafting plyers not going to the World Cup, I also wondered what a 'Rest of the World' 11 would look like/fare.

```{r libraries, warning=FALSE,message=FALSE}
library(dplyr)
library(magrittr)
library(data.table)
library(ggplot2)
```

#Building Teams

To save time, I'm gonig to used saved versions of the datasets I built up over the 5 blog posts.

```{r secretly_load_data, warning=FALSE,message=FALSE,echo=FALSE}
#world rankings
world_rankings <- readRDS("C:/Users/Robert/Desktop/New Coding/March 2018 UK World Cup/national_rankings.rds")

#player data
all_players_data <- readRDS("C:/Users/Robert/Desktop/New Coding/March 2018 UK World Cup/all_players_position_data.rds")
#all British players
british_player_birthplaces <- readRDS("C:/Users/Robert/Desktop/New Coding/March 2018 UK World Cup/british_player_birthplaces.rds")

world_cup_countries <- c("Russia", "Saudi Arabia", "Egypt", "Uruguay",
                         "Portugal", "Spain", "Morocco", "Iran",
                         "France", "Australia", "Peru", "Denmark",
                         "Argentina", "Iceland", "Croatia", "Nigeria",
                         "Brazil", "Switzerland", "Costa Rica", "Serbia",
                         "Germany", "Mexico", "Sweden", "Korea Republic",
                         "Belgium", "Panama", "Tunisia", "England",
                         "Poland", "Senegal", "Colombia", "Japan")

#load the data to save having to recalculate optimal teams
optimal_national_teams <- readRDS("C:/Users/Robert/Desktop/New Coding/March 2018 UK World Cup/optimal_national_teams.rds")
national_teams <- readRDS("C:/Users/Robert/Desktop/New Coding/March 2018 UK World Cup/national_teams.rds")

#grab a link to all the default FIFA18 formations
link <- "https://www.fifauteam.com/fifa-18-formations-guide/#4222"

library(rvest)
#get all the formations
formations <- read_html(link) %>%
  html_nodes("h2") %>%
  html_text() %>%
  .[2:length(.)]

#get all the positions per formation
positions <- read_html(link) %>%
  html_nodes("td:nth-child(1)") %>%
  html_text() %>%
  gsub(" .", "", .) %>%
  #make positions symmetric
  gsub("RF|LF", "CF", .) %>%
  gsub("CMR|CML", "CM", .) %>%
  gsub("^R|^L", "W", .)

#df of each formation and the positions it contains
formations_df <- data.frame(formation = rep(formations, each = 10),
                            position = positions)
#get the coords for different formations
formation_coords <- readRDS("C:/Users/Robert/Desktop/New Coding/March 2018 UK World Cup/player_position_coords.rds")
formation_coords$player_y[which(formation_coords$unique_position == "CB")] <- 24
formation_coords$player_y[which(formation_coords$unique_position == "CB.2")] <- 51
```

```{r load_data, warning=FALSE,message=FALSE,eval=FALSE}
#world rankings
world_rankings <- readRDS("national_rankings.rds")

#player data
all_players_data <- readRDS("all_players_position_data.rds")
#all British players
british_player_birthplaces <- readRDS("british_player_birthplaces.rds")

#the countries going to the world cup
world_cup_countries <- c("Russia", "Saudi Arabia", "Egypt", "Uruguay",
                         "Portugal", "Spain", "Morocco", "Iran",
                         "France", "Australia", "Peru", "Denmark",
                         "Argentina", "Iceland", "Croatia", "Nigeria",
                         "Brazil", "Switzerland", "Costa Rica", "Serbia",
                         "Germany", "Mexico", "Sweden", "Korea Republic",
                         "Belgium", "Panama", "Tunisia", "England",
                         "Poland", "Senegal", "Colombia", "Japan")

#load data to save having to recalculate optimal teams
optimal_national_teams <- readRDS("optimal_national_teams.rds")
national_teams <- readRDS("national_teams.rds")

#the formations for selecting teams
formations_df <- readRDS("formations_df.rds")
formation_coords <- readRDS("player_position_coords.rds")

```

I won't include the functions in this blog post either, but the article uses (at most very slight modified) functions from the previous 5 posts.

```{r secret_functions, warning=FALSE,message=FALSE,echo=FALSE}
find_optimal_team <- function(nation, players, replicates) {
  #find only players available to play for that nation
  players_pool <- players %>%
    filter(nationality == nation)
  
  #find the best team that can be played using these players for each default formation
  best_team <- rbindlist(lapply(rep(unique(formations_df$formation), replicates), pick_players, players = players_pool)) %>%
    #select only the formation/team with the highest total ability
    filter(total_ability == max(total_ability)) %>%
    #in case there are multiple best teams, take the first
    .[1:11,] %>%
    #add the nation as an id
    mutate(nation = nation)
  
  return(best_team)
}  

pick_players <- function(players, formation) {
  #get all the positions for he formation being tested
  formation_positions <- formations_df$position[formations_df$formation == formation]
  #randomise the order of positions to pick
  positions <- sample(as.character(formation_positions))
  #add the goalkeeper as the first to be picked
  positions <- append("GK", positions)
  
  #for each position that needs a player
  for(position in positions) {
    if(position != "GK") {
      #generate a random number to determine if picking the best, second best, or third best player for that position
      #might not always be optimal to pick the best player if they are even better in another position
      randomiser <- runif(1)
      #pick the corresponding player
      if(randomiser < 0.6 | nrow(players) < 3) {
        id <- players$id[which.max(players[[position]])]
      } else if(randomiser < 0.9) {
        id <- players$id[order(-players[[position]])][2]
      } else {
        id <- players$id[order(-players[[position]])][3]
      }
    } else {
      #always pick the best goalkeeper available
      id <- players$id[which.max(players[[position]])]
    }
    
    #get the ability of that player in the position sampled
    ability <- players[[position]][which(players$id == id)]
    
    #create a df of all the players picked for this formation
    if(position == "GK") {
      team <- data.frame(id = id, position = position, ability = ability)
    } else {
      team <- rbind(team, data.frame(id = id, position = position, ability = ability))
    }
    #for each player picked, remove it from further consideration for other positions
    players <- players[-which(players$id == id),]
  }
  
  #get the total ability of the team by averaging their position abilities
  team$total_ability <- sum(team$ability) / 11
  team$formation <- formation
  return(team)
}

draw_pitch <- function(plot) {
  pitch <- plot +
    geom_rect(aes(xmin=-5,xmax=115/2+5,ymin=-5,ymax=80),
              fill = "#98FB98", colour = NA) +
    geom_rect(aes(xmin=0,xmax=115/2,ymin=0,ymax=75), 
              fill = NA, colour = "#FFFFFF", size = 1.5) +
    geom_rect(aes(xmin=0,xmax=18, ymin=(75-44)/2,ymax=75-(75-44)/2),
              fill = NA, colour = "#FFFFFF", size = 1.5) +
    geom_rect(aes(xmin=0,xmax=6, ymin=(75-20)/2,ymax=75-(75-20)/2),
              fill = NA, colour = "#FFFFFF", size = 1.5) +
    geom_point(aes(x=12,y=75/2),
               colour = "#FFFFFF", size = 3) +
    geom_point(aes(x=115/2,y=75/2), colour = "#FFFFFF", size = 3) +
    geom_segment(aes(x=0,xend=0,y=(75-8)/2,yend=75-(75-8)/2),
                 colour = "#000000", size = 2) +
    geom_path(data = filter(circleFun(c((115/2),(75/2)),20,npoints=1000),
                            x<=115/2), aes(x=x,y=y), colour = "#FFFFFF", size = 1.5) +
    geom_path(data = filter(circleFun(c((0),(75)),2.5,npoints=1000),
                            x>=0 & y<=75), aes(x=x,y=y), colour = "#FFFFFF", size = 1.5) +
    geom_path(data = filter(circleFun(c(0,0),2.5,npoints=1000),
                            x>=0 & y>=0), aes(x=x,y=y), colour = "#FFFFFF", size = 1.5) +
    geom_path(data = filter(circleFun(c((12),(75/2)),20,npoints=1000),
                            x>=18 & y>=0), aes(x=x,y=y), colour = "#FFFFFF", size = 1.5) +
    theme(rect = element_blank(), 
          line = element_blank(),
          axis.title=element_blank(),
          axis.text=element_blank(),
          axis.ticks=element_blank()) +
    coord_flip()
  return(pitch)
}

circleFun <- function(center = c(0,0), diameter = 1, npoints = 100){
    r = diameter / 2
    tt <- seq(0,2*pi,length.out = npoints)
    xx <- center[1] + r * cos(tt)
    yy <- center[2] + r * sin(tt)
    return(data.frame(x = xx, y = yy))
}
```

We first need to sort the players into either the UK vs. the rest of the World* and finding the optimal teams for each, as we did prviously.

*it's possible Welsh (especially Gareth Bale), Northern Irish, or Scottish players might make the rest of the World team, but I'll ignore that possibility for simplicity

```{r rest_of_the_world, warning=FALSE,message=FALSE}
#get the names of each player to merge in
player_lookup <- all_players_data %>%
  select(id, name, nationality) %>%
  mutate(original_nation = as.character(nationality))

#sort the data for finding teams
nationalised_players <- all_players_data %>%
  setDT() %>%
  #convert british players nationality to UK
  .[id %in% british_player_birthplaces$id, nationality := "UK"] %>%
  #filter out players from countries at the world cup
  .[!nationality %in% world_cup_countries] %>%
  #convert non-UK players nationality to "Rest of World"
  .[!id %in% british_player_birthplaces$id, nationality := "RoW"]

#find the optimal teams for both these nations
extranational_teams <- rbindlist(lapply(unique(nationalised_players$nationality), find_optimal_team, 
                                           select(nationalised_players, id, nationality, 49:60), replicates = 100))

```

These can then be plotted to show the teams as before.

```{r}

#select the best 4 county teams by total ability
extranational_teams %<>%
  setDT() %>%
  .[, unique_position := make.unique(as.character(position)), by = "nation"] %>%
  merge(., formation_coords, by = c("formation", "unique_position")) %>%
  merge(player_lookup, by = "id") 

#plot the data
p <- ggplot(data = extranational_teams)
p <- p %>%
  #custom pitch aesthetic function
  draw_pitch()
p <- p + 
  geom_text(aes(x = player_x, y = player_y, label = gsub(" ", "\n", name), colour = original_nation), fontface = "bold") +
  scale_colour_manual(values = c("darkred", "white", "yellow", "blue", "darkblue", "orange", "blue", "white", "red"),
                      guide = FALSE) +
  facet_wrap(~nation)

plot(p)

```

#Calculating Ability

As previously, we can calculate the expected ELO of such teams via linear regression of the FIFA18 ability vs. ELO of actual national teams.

This time, let's predict the ability of the extranational teams based on this regression before plotting, just to save on plots/time/code/etc.

```{r ELO_ability_relationship, warning=FALSE,message=FALSE}
#merge in the world rankings for each fieldable national team
national_teams %<>% merge(., world_rankings, by = "nation") %>%
  #merge in the optimal team total_ability for each nation
  merge(., unique(select(optimal_national_teams, nation, total_ability)), by = "nation")

#regress ELO against total_ability (as judged by selection of FIFA18 players)
ability_regression <- lm(data = national_teams, ELO ~ total_ability)

#munge the extranational teams df to predict the ELO
extranational_teams <- data.frame(nation = c("UK", "RoW")) %>%
  merge(., select(extranational_teams, nation, total_ability), by = "nation") %>%
  #predict the ELO of each county using the previous regression
  mutate(predicted_ELO = predict(ability_regression, .)) %>%
  unique()

```

Then we can plot this regression and see where the RoW and UK fall in terms of actual nations

```{r plot_regression, warning=FALSE,message=FALSE}
#plot ELO vs. total_ability
p <- ggplot(data = national_teams, aes(x = total_ability, y = ELO)) +
  geom_text(aes(label = nation), colour = "grey60") +
  #add in the linear regression line + confidence intervals
  stat_smooth(method = "lm", colour = "darkred") +
  geom_text(data = extranational_teams, aes(label = nation, x = total_ability, y = predicted_ELO), colour = "darkblue") +
  xlab("FIFA18 Optimal Team Ability") +
  ylab("National Team ELO") +
  ggtitle("FIFA18 ability vs. ELO for National Teams") +
  theme_minimal()

plot(p)
```

What's quite nice about the graph is it shows the limitation of this approach. By definition, a UK team should be _at least_ as good as the English national team, but because England overperform their 'FIFA ability', the UK is actually ranked a fair bit lower in terms of ELO

```{r UK_ELOs, warning=FALSE,message=FALSE}
#show the ELOs of the English national football team
#and predicted ELO of a UK team
national_teams$ELO[national_teams$nation == "England"]

extranational_teams$predicted_ELO[extranational_teams$nation == "UK"]

```

The RoW team is similarly probably undervalued in terms of ELO. FIFA18 ranks the players as a lot better than teams like Germany and Brazil, but with much lower ELO

```{r world_cup_draw_info, warning=FALSE,message=FALSE,echo=FALSE}
wc_teams <- data.frame(nation = c("Russia", "Saudi Arabia", "Egypt", "Uruguay",
                                  "Portugal", "Spain", "Morocco", "Iran",
                                  "France", "Australia", "Peru", "Denmark",
                                  "Argentina", "Iceland", "Croatia", "Nigeria",
                                  "Brazil", "Switzerland", "Costa Rica", "Serbia",
                                  "Germany", "Mexico", "Sweden", "Korea Republic",
                                  "Belgium", "Panama", "Tunisia", "England",
                                  "Poland", "Senegal", "Colombia", "Japan"),
                       group = c(rep(letters[1:8], each = 4)),
                       draw = rep(1:4, 8))

group_matches <- data.frame(match = 1:6,
                            team1 = c(1,3,1,4,4,2),
                            team2 = c(2,4,3,2,1,3))

knockout_matches <- data.frame(round = c(rep("R16", 8), rep("QF", 4), rep("SF", 2), "F"),
                               team1 = c("a1", "c1", "e1", "g1", "b1", "d1", "f1", "h1",
                                         "m49", "m53", "m51", "m55", "m57", "m59", "m61"),
                               team2 = c("b2", "d2", "f2", "h2", "a2", "c2", "e2", "g2",
                                         "m50", "m54", "m52", "m56", "m58", "m60", "m62"),
                               match_id = c("m49", "m50", "m53", "m54", "m51", "m52", "m55", "m56",
                                            "m57", "m58", "m59", "m60", "m61", "m62", "FINAL"))

#uses ELO to calculate the chance of team A winning
calc_win_chance <- function(ratingA, ratingB) {
  win_chance <- 1/ (1+10^((ratingB-ratingA)/400))
}

#simulate the group stages of the tournament
simulate_groups <- function(group_letter, national_teams, group_matches) {
  group <- national_teams %>%
    filter(group == group_letter) %>%
    mutate(points = 0) %>%
    mutate(av_difference = 0) %>%
    arrange(draw)
  
  #six matches per group
  for(match in 1:6){
    team1 <- group$nation[group_matches$team1[match]]
    team2 <- group$nation[group_matches$team2[match]]
    
    #calculate winner using a random number generator and comparing to the ELO win percentages
    random_number_draw <- runif(1)
    win_chance <- calc_win_chance(group$ELO[group$nation == team1], group$ELO[group$nation == team2])
    
    #update ELOs and assign group stage points
    if(win_chance - random_number_draw > 0.1) {
      group$points[group$nation == team1] <- group$points[group$nation == team1] + 3
      group$points[group$nation == team2] <- group$points[group$nation == team2] + 0
      
      group$ELO[group$nation == team1] <- group$ELO[group$nation == team1] + 50*(1-win_chance)
      group$ELO[group$nation == team2] <- group$ELO[group$nation == team2] + 50*(0-(1-win_chance))
      
    } else if(win_chance - random_number_draw < -0.1) {
      group$points[group$nation == team1] <- group$points[group$nation == team1] + 0
      group$points[group$nation == team2] <- group$points[group$nation == team2] + 3
      
      group$ELO[group$nation == team1] <- group$ELO[group$nation == team1] + 50*(0-win_chance)
      group$ELO[group$nation == team2] <- group$ELO[group$nation == team2] + 50*(1-(1-win_chance))

    } else {
      group$points[group$nation == team1] <- group$points[group$nation == team1] + 1
      group$points[group$nation == team2] <- group$points[group$nation == team2] + 1
      
      group$ELO[group$nation == team1] <- group$ELO[group$nation == team1] + 50*(0.5-win_chance)
      group$ELO[group$nation == team2] <- group$ELO[group$nation == team2] + 50*(0.5-(1-win_chance))
    }
    
    group$av_difference[group$nation == team1] <- group$av_difference[group$nation == team1] + 
      (group$ELO[group$nation == team1] - group$ELO[group$nation == team2])
    group$av_difference[group$nation == team2] <- group$av_difference[group$nation == team2] - 
      (group$ELO[group$nation == team1] - group$ELO[group$nation == team2])
  }
  
  #arrange the groups by points per team, then by the ELO difference between a team and it's rivals
  #use ELO difference as secondary sorter as proxy for goal difference
  group <- arrange(group, -points, -av_difference) %>%
    mutate(position = 1:4)
  return(group)
}

#simulate the knockout rounds
simulate_knockout_rounds <- function(national_teams, knockout_matches) {
  for(match in seq(nrow(knockout_matches))) {
    #get the teams and the match id
    team1 <- as.character(national_teams$nation[which(national_teams$id == knockout_matches$team1[match])])
    team2 <- as.character(national_teams$nation[which(national_teams$id == knockout_matches$team2[match])])
    match_id <- as.character(knockout_matches$match_id[match])
    
    national_teams$id[which(national_teams$nation %in% c(team1, team2))] <- match_id
    
    #use a random number generator to decide the winner
    random_number_draw <- runif(1)
    
    #use ELO chances vs. the random number to work out which team wins
    win_chance <- calc_win_chance(national_teams$ELO[national_teams$nation == team1], national_teams$ELO[national_teams$nation == team2])
    
    #update ELOs and remove losing team
    if(win_chance > random_number_draw) {
      national_teams$ELO[national_teams$nation == team1] <- national_teams$ELO[national_teams$nation == team1] + 50*(1-win_chance)
      national_teams <- national_teams[-which(national_teams$nation == team2),]
    } else {
      national_teams$ELO[national_teams$nation == team2] <- national_teams$ELO[national_teams$nation == team2] + 50*(1-(1-win_chance))
      national_teams <- national_teams[-which(national_teams$nation == team1),]
    }
  }
  #returns the nation from the last remain row of the df == the winner of the tournament
  return(national_teams$nation)
}

#simulate the whole tournament
simulate_tournament <- function(national_teams, knockout_matches, group_matches) {
  #simulate the group stages
  knockout_rounds <- rbindlist(lapply(letters[1:8], simulate_groups,  
                                      national_teams = national_teams, group_matches = group_matches)) %>%
    #filter the top two teams from each group
    filter(position < 3) %>%
    mutate(id = paste0(group, position)) %>%
    select(nation, ELO, id)
  
  #simulate the knockout rounds until only 1 team remains
  winner <- simulate_knockout_rounds(national_teams = knockout_rounds, knockout_matches = knockout_matches) %>%
    as.character()
  return(winner)
}
```


We can then run the simulations, swapping the UK/RoW in for countries. The obvious substitute for the UK is England. For the RoW I decided to remove the team with the lowest ELO, which turns out to be Saudi Arabia

```{r simulate_world_cups, warning=FALSE,message=FALSE}
#merge the ELOs with the world cup draw information
wc_teams %<>% merge(., select(national_teams, nation, ELO) %>%
                      rbind(., data.frame(nation = "Panama", ELO = 1669)), by = "nation")
wc_teams$nation <- as.character(wc_teams$nation)

simulate_counties <- function(extranation, simulations, replace_country) {
  #replace Englands ELO with that of the county team replacing them
  wc_teams$ELO[wc_teams$nation == replace_country] <- extranational_teams$predicted_ELO[extranational_teams$nation == extranation]
  wc_teams$nation[wc_teams$nation == replace_country] <- extranation
  
  #run x number of simulations
  for(simulation in 1:simulations) {
    winner <- simulate_tournament(wc_teams, knockout_matches, group_matches)
    if(simulation == 1) {
      winners <- winner
    } else {
      winners <- append(winners, winner)
    }
  }
  
  #spit out a df with each winner and the number of times they win
  simulation_df <- data.frame(table(winners))
  names(simulation_df) <- c("nation", "championships")
  
  #work out the percentage chane of each nation/county winning
  simulation_df$percentage <- simulation_df$championships / (simulations/100)
  return(simulation_df)
}

#run the simulations
UK_simulation <- simulate_counties("UK", 1000, "England") %>% 
  mutate(simulation = "UK")
RoW_simulation <- simulate_counties("RoW", 1000, wc_teams$nation[which.min(wc_teams$ELO)]) %>%
  mutate(simulation = "RoW")

```

```{r munge_simulation_results, warning=FALSE,message=FALSE}
simulation_results <- rbind(UK_simulation, RoW_simulation) %>%
  setDT() %>%
    .[, perc_chance := mean(percentage), by = "nation"] %>%
  .[, c("nation", "perc_chance")] %>%
  unique(.) %>%
  .[nation %in% c("RoW", "UK"), nation_status := "simulation"] %>%
  .[!nation %in% c("RoW", "UK"), nation_status := "nation"] %>%
  #order by percentage chance of winning the WC
  .[, nation := factor(nation, levels = nation[order(-.$perc_chance)])]

#plot the results
p <- ggplot(data = simulation_results, aes(x = nation, y = perc_chance)) +
  geom_bar(stat = "identity", aes(fill = nation_status)) +
  scale_fill_manual(values = c("darkblue", "darkred"), name = "Nation Status") +
  xlab("Team") +
  ylab("World Cup Win Percentage Chance") +
  ggtitle("Percetange Chance of Winning the World Cup from 1000 Simulations",
          subtitle = "UK/RoW Substituted for England/Saudi Arabia Respectively") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1.2))

plot(p)
  
```

The team for the RoW tend to do fairly well. In fact only Brazil, Germany, or Spain (3 of the tournament favourites) tend to win more simulated World Cups than them. The team for the whole of the UK disappoints as much as the English national team, winning about the same as the original, and other similarly ranked nations, such as Colombia, or Peru.

