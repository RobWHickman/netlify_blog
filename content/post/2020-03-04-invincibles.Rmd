---
title: Five Minute Football Trivia - Invincibles
author: Robert Hickman
date: '2020-03-04'
slug: five_min_trivia_invincibles
output: pdf_document
categories: []
tags:
  - fivemintrivia
  - football
header:
  caption: ''
  image: ''
---

_generally as I have less and less time to waste on meaningless football stats I get halfway through a post and abandon it. To remedy this, I want to start pushing out posts that give a reasonable half-guess at an answer within an hour or so without needing to really check my working or write good prose. This is the first of these_

Liverpool Football Club have had a pretty impressive season until recently, winning [26 of the first 27 games](https://www.google.com/search?client=firefox-b-d&q=premier+league+table#sie=lg;/g/11fj6snmjm;2;/m/02_tc;st;fp;1;;) and remaining unbeaten. Last weekend however, they lost [3-0 to Watford](https://www.bbc.co.uk/sport/football/51595064) which means that Arsenal remain the only team to have gone a full (modern) season of top flight English football unbeaten (in [2003-2004](https://en.wikipedia.org/wiki/The_Invincibles_(football))). 

Modern football twitter being what it is, a lot of debate has sprung up about which would be more impressive- going to whole season unbeaten like Arsenal, or winning 100 (out of a max 114) points in a single season, as Manchester City did in 2017-2018 and both Manchester City and Liverpool _almost_ did last season. (A third option also is the treble won by Manchester United in [1998-1999](https://en.wikipedia.org/wiki/1998%E2%80%9399_Manchester_United_F.C._season) but since Liverpool have also lost to Chelsea in the FA cup this week, that too remains unbeaten).

As usual, first we need some libraries

```{r libraries, warning=FALSE,message=FALSE}
#munging
library(tidyverse)
#plotting
library(ggrepel)
#football data
library(engsoccerdata)
library(rvest)
#Ben Torvaney's excellend package to model football
library(regista)

#set seed for reproducibility
set.seed(22081992)
```

Then we can get going loading up the data on English football results up until the end of the 2018/2019 season. We'll also take some time to find the winners each season which will be useful later. There's a lot of repetetive munging in this post so bear in mind the 3 main things we'll be doing are:
+ pivoting data to longer to get the results for each team (not each match)
+ working out the goals for and against each team using case_when()
+ working out the points for each team using case_when()

```{r get_footie_data, warning=FALSE,message=FALSE}
data <- engsoccerdata::england %>%
  #only care about the top flight in the premier league era
  dplyr::filter(Season > 1991 & Season < 2019 & division == 1) %>%
  select(season = Season, home, away = visitor, hgoal, agoal = vgoal)

league_winners <- data %>%
  #pivot data to longer to get team (rather than match) data
  pivot_longer(c("home", "away"), names_to = "location", values_to = "team") %>%
  #find goals for and goals against per team
  mutate(g_for = case_when(
    location == "home" ~ hgoal,
    location == "away" ~ agoal
  )) %>%
  mutate(g_ag = case_when(
    location == "home" ~ agoal,
    location == "away" ~ hgoal
  )) %>%
  #get the team's points per match
  mutate(points = case_when(
    g_for > g_ag ~ 3,
    g_for == g_ag ~ 1,
    g_ag > g_for ~ 0
  )) %>%
  mutate(gd = g_for - g_ag) %>%
  group_by(team, season) %>%
  #calculate total points and goal difference
  summarise(total_points = sum(points),
            total_gd = sum(gd)) %>%
  #get the winners of each league season
  arrange(season, -total_points, -total_gd) %>%
  group_by(season) %>%
  mutate(league_position = 1:n()) %>%
  ungroup() %>%
  mutate(winner = case_when(
    league_position == 1 ~ "y",
    TRUE ~ "n"
  ))

head(league_winners)
```

We can then use the match data to calculate the offensive and defensive strength of each teams over the whole season using the [Dixon-Coles method](https://rss.onlinelibrary.wiley.com/doi/pdf/10.1111/1467-9876.00065). I've previously written an introduction to this method [here](https://www.robert-hickman.eu/post/dixon_coles_1/) (which I need to finish part two of) but suffice to say it takes the goals scored and goals conceeded per game and gives a good estimation of how good a team is. It's similar in concept to [fivethirtyeight's Soccer SPI](https://projects.fivethirtyeight.com/soccer-predictions/).

```{r fit_dc, warning=FALSE,message=FALSE}
#split data by seasons
fit_data <- data %>%
  split(f = .$season) %>%
  lapply(., function(x) x %>% mutate(home = factor(home), away = factor(away)))

#model using dixoncoles() from the regista package
fits <- lapply(fit_data, function(x) dixoncoles(hgoal, agoal, home, away, x))
```

We can then extract the parameters from this model to see how teams have performed in each season of the Premier League. I also flip the defence axis (higher being a better defence) as I think it makes a little more sense

```{r get_dc_parameters, warning=FALSE,message=FALSE}
parameters <- fits %>%
  #extract the team parameters per fit
  lapply(., function(f) {
    par_data <- f$par[grepl("def_|off_", names(f$par))]
    teams <- unique(gsub("def_*|off_*", "", names(par_data)))
    par_df <- matrix(par_data, ncol = 2) %>%
      as.data.frame() %>%
      rename(attack = V1, defence = V2)
    rownames(par_df) <- teams
    return(par_df)
  }) %>%
  do.call(rbind, .) %>%
  rownames_to_column() %>%
  separate(rowname, c("season", "team"), sep = "\\.") %>%
  mutate(season = as.numeric(season)) %>%
  #flip the defence parameter (higher = better)
  mutate(defence = defence * -1) %>%
  left_join(., league_winners, by = c("season", "team"))

#plot the parameters with season performance (points) as the colour
p1 <- parameters %>%
  ggplot(aes(x = attack, y = defence, fill = total_points, colour = winner)) +
  geom_point(shape = 21, size = 3, alpha = 0.7, stroke = 2) +
  #label exceptional teams
  geom_text_repel(data = filter(parameters, winner == 1 | attack + defence > 1),
            aes(label = paste(team, season))) +
  labs(title = "Dixon Coles parameters per team per Premier League Season",
       subtitle = "league winners and exceptional teams labelled",
       x = "attacking strength",
       y = "defensive strength") +
  scale_colour_manual(values = c("blue", "red")) +
  theme_minimal()

p1
```
We can then use these parameters as 'true estimates' of how good each team was each season, and go back and simulate results from each match to work out how likely a win/lose/draw for any team was in any match. This is questionably a good idea but as I said up top, this is stream of consciousness first-guesses at answering stupid trivia questions so I'm going to go along with it.

The regista package's augment.dixoncoles easily gives us the chance of a win/lose/draw per match based on the attacking/defensive strength of each team (see above) that season

```{r backpredict_results, warning=FALSE,message=FALSE}
#split the matches by season
matches <- data %>%
  select(season, home, away) %>%
  split(f = .$season)

#function to predict the results per match
predict_matches <- function(dc_fit, fixtures) {
  augment.dixoncoles(x = dc_fit, newdata = fixtures, type = "outcomes") %>% 
    unnest() %>%
    spread(outcome, prob)
}

#run the prediction function
predictions <- map2_df(fits, matches,
                       predict_matches)

head(predictions)
```
So e.g. based on Dixon-Coles estimates, given how well Arsenal and Aston Villa did over the _whole_ of the 1992/1993 season, Arsenal had a 32.6% chance of beating Aston Villa at home on the opening day of the season.

We can then use these probability estiamtes to calculate the chance of any one team going unbeaten over the whole league (multiply out the probabilities of not losing each game)

```{r invincible_chance, warning=FALSE,message=FALSE}
invincible_chance <- predictions %>%
  #get match predictions per team
  pivot_longer(c("home", "away"), names_to = "location", values_to = "team") %>%
  mutate(nonloss_chance = case_when(
    location == "home" ~ 1 - away_win,
    location == "away" ~ 1 - home_win
  )) %>%
  select(season, team, nonloss_chance) %>%
  group_by(team, season) %>%
  #chance of going invincible = product sum of chance of not drawing
  summarise(invincible_chance = prod(nonloss_chance)) %>%
  arrange(-invincible_chance)

head(invincible_chance, n = 10)
```

So it turns out that the team most likely to have gone invincible over a whole season was Chelsea in 2004/2005 (not surprising given their [excellent defensive record that year](https://en.wikipedia.org/wiki/2004%E2%80%9305_Chelsea_F.C._season#Results_by_round)), but with only a ~5% chance. 

Arsenal's _actual_ invincible year is estimated that have had a 0.05% chance based on the team's results (surprisingly low!). Another notable team is Tottenham Hotspur who only finished 2nd in 2016/2017 but perhaps went under the radar as a very good team that year (with a 0.08% chance of finishing unbeaten).

So we can assume* that the very best 'unbeatable' teams have ~5% chance of finishing a season invincible. We can use this baseline to see how hard this seems compared to the expectation a team gets 100 points.

*not really, but for this post yes

We're going to simulate every Premier League season 1000 times and calculate the total points expected of a team based on their Dixon-Coles parameters. To narrow down the search a bit, Im going to limit it to only exceptional teams with an attack and defence parameter > 0.25 (which gives 33 season-teams).

```{r simulate_all_matches, warning=FALSE,message=FALSE}
result_probs <- predictions %>%
  #pivoting and case_when to get result probabilities per team
  pivot_longer(c("home", "away"), names_to = "location", values_to = "team") %>%
  mutate(win = case_when(
    location == "home" ~ home_win,
    location == "away" ~ away_win
  )) %>%
  mutate(lose = 1 - draw - win) %>%
  select(season, team, win, lose, draw) %>%
  group_by(team, season) %>%
  mutate(game = 1:n()) %>%
  nest(probs = c(win, lose, draw))

#filter down to only the very best teams to save processing
selected_teams <- parameters %>%
  filter(attack > 0.25 & defence > 0.25) %>%
  select(season, team) %>%
  left_join(., result_probs, by = c("team", "season"))

sim_result <- function(probabilities) {
  chosen_results <- gather(probabilities) %>%
    sample_n(., 1, weight = value)
  result <- chosen_results$key
}

simulate_all_games <- function(data) {
  data$result <- unlist(lapply(data$probs, sim_result))
  return(data)
}

#will simulate 1000 seasons for each of these teams
n_sims <- 1000

#run simulations - will take ~10mins
simulated_results <- rerun(n_sims, simulate_all_games(selected_teams))
```

Calculating the total points won per season, we can work out the percentage of simulations in which each team exceed 100 points quite easily

```{r centurion_probs, warning=FALSE,message=FALSE}
simulated_points <- simulated_results %>%
  #for each sim, get the points won by each team
  lapply(., function(data) {
    data <- data %>%
      mutate(points = case_when(
        result == "win" ~ 3,
        result == "draw" ~ 1,
        result == "lose" ~ 0
      )) %>%
      group_by(season, team) %>%
      mutate(total_points = sum(points)) %>%
      select(season, team, total_points) %>%
      unique()
  }) %>%
  do.call(rbind, .)

#probability of reaching 100 points is no. of sims > 100 points / n_sims
centurion_probs <- simulated_points %>%
  filter(total_points > 99) %>%
  group_by(season, team) %>%
  summarise(centurion_prob = n() / n_sims) %>%
  arrange(-centurion_prob)

print(centurion_probs)
```

As expected, the two recent Manchester City teams come top, with the one that actually did reach 100 points (2017) given a 14.5% chance of reaching that milestone, given their strength. 

So now we have a baseline that the best team at accumulating points (Manchester City 2017/2018) has ~3x as much chance of winning 100 points in that season than the very best (potentially) invincible team (Chelsea 2004/2005). I.e. we have some (not super strong) evidence that it is ~3x as hard to go a season unbeaten than it is to become a 'centurion'.

We can calculate how many points our threshold needs to be set at to have an equal chance using top_frac() on our 1000 simulations. 

```{r man_city_acheivment, warning=FALSE,message=FALSE}
invincible_equivalent <- simulated_points %>%
  ungroup() %>%
  filter(season == 2017 & team == "Manchester City") %>%
  top_frac(max(invincible_chance$invincible_chance)) %>%
  arrange(total_points)

head(invincible_equivalent, n = 1)

p2 <-  simulated_points %>%
  ungroup() %>%
  filter(season == 2017 & team == "Manchester City") %>%
  ggplot(., aes(x = total_points)) +
  geom_histogram(fill = "skyblue", alpha = 0.8) +
  geom_vline(xintercept = min(invincible_equivalent$total_points), colour = "red")


```

```{r get_2020_data, warning=FALSE,message=FALSE}
fixtures_2020 <- "https://fbref.com/en/comps/9/schedule/Premier-League-Fixtures" %>%
  read_html() %>%
  html_nodes("#sched_ks_3232_1") %>%
  html_table() %>%
  as.data.frame() %>%
  separate(Score, into = c("hgoal", "agoal"), sep = "â€“") %>%
  select(home = Home, away = Away, home_xg = xG, away_xg = xG.1, hgoal, agoal) %>%
  filter(home != "") %>%
  mutate(home = factor(home), away = factor(away)) %>%
  mutate_at(c("home_xg", "away_xg", "hgoal", "agoal"), .funs = funs(round(as.numeric(.))))

played_matches <- fixtures_2020 %>%
  filter(!is.na(home_xg))

unplayed_matches <- fixtures_2020 %>%
  filter(is.na(home_xg)) %>%
  select_if(negate(is.numeric))

fit_2020 <- dixoncoles(home_xg, away_xg, home, away, data = played_matches)
```

```{r 2020_dc_parameters, warning=FALSE,message=FALSE}
pars_2020 <- fit_2020$par %>%
  .[grepl("def_|off_", names(.))] %>%
  matrix(., ncol = 2) %>%
  as.data.frame() %>%
  rename(attack = V1, defence = V2)
pars_2020$team <- unique(gsub("def_*|off_*", "", names(fit_2020$par)))[1:20]


p3 <- pars_2020 %>%
  mutate(defence = 1 - defence) %>%
  ggplot(aes(x = attack, y = defence, colour = attack + defence, label = team)) +
  geom_point(size = 3, alpha = 0.7) +
  geom_text_repel() +
  labs(title = "Dixon Coles parameters per team 2019/2020",
       x = "attacking strength",
       y = "defensive strength") +
  scale_colour_continuous(guide = FALSE) +
  theme_minimal()

```


```{r liverpool_103_chance, warning=FALSE,message=FALSE}
liverpool_points <- played_matches %>%
  filter(home == "Liverpool" | away == "Liverpool") %>%
  mutate(points = case_when(
    hgoal == agoal ~ 1,
    home == "Liverpool" & (hgoal > agoal) ~ 3,
    away == "Liverpool" & (agoal > hgoal) ~ 3,
    TRUE ~ 0
  )) %>%
  summarise(total_points = sum(points))

unplayed_scorelines <-
  augment.dixoncoles(fit_2020, unplayed_matches, type.predict = "scorelines") %>%
  unnest() %>%
  filter(home == "Liverpool" | away == "Liverpool") %>%
  filter(prob > 0.01)

simulate_season <- function(scoreline_probabilities) {
  scoreline_probabilities %>%
    nest(hgoal, agoal, prob, .key = "scorelines") %>%
    mutate(sampled = map(scorelines, ~ sample_n(., 1, weight = prob))) %>%
    select(-scorelines) %>%
    unnest()
}

liverpool_2020_simulated <- rerun(n_sims, simulate_season(unplayed_scorelines)) %>%
  bind_rows(.id = "simulation_id") %>%
  mutate(points = case_when(
    hgoal == agoal ~ 1,
    home == "Liverpool" & (hgoal > agoal) ~ 3,
    away == "Liverpool" & (agoal > hgoal) ~ 3,
    TRUE ~ 0
  )) %>%
  group_by(simulation_id) %>%
  summarise(total_points = sum(points) + as.numeric(liverpool_points))

```

```{r liverpool_expected_points, warning=FALSE,message=FALSE}
length(which(liverpool_2020_simulated$total_points > 102)) / 1000

```

```{r plot_liverpool_expectation, warning=FALSE,message=FALSE}
p4 <- liverpool_2020_simulated %>%
  ggplot(., aes(x = total_points)) +
  geom_histogram(fill = "red", alpha = 0.8)

p4
```


