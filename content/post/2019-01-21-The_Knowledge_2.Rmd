---
title: Which English County Has Won the Most Points
author: Robert Hickman
date: '2019-01-21'
slug: counties_league_points
output: pdf_document
categories: []
tags:
  - rstats
  - football
  - the_knowledge
  - maps
header:
  caption: ''
  image: ''
---

Every so often a question on The Guardian's [The Knowledge](https://www.theguardian.com/football/series/theknowledge) football trivia section piques my interest and is amenable to analysis using R. Previously, I looked at [club name suffixes and young World Cup winners](http://www.robert-hickman.eu/post/the-knowledge-4th-august-2018/) last August. This week (give or take), a question posed on twitter caught my attention:

<blockquote class="twitter-tweet" data-lang="en"><p lang="en" dir="ltr"><a href="https://twitter.com/TheKnowledge_GU?ref_src=twsrc%5Etfw">@TheKnowledge_GU</a> was just chatting to some colleagues in the kitchen at work about why Essex doesn&#39;t have many big football clubs and it got me thinking. If you combined all the points from every league team in the ceremonial counties in England, which county would be on top?</p>&mdash; BoxBoron (@Rutland_Walker) <a href="https://twitter.com/Rutland_Walker/status/1082641231853899781?ref_src=twsrc%5Etfw">January 8, 2019</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

To start with as always load the libraries needed to analyse this

```{r libraries, warning=FALSE,message=FALSE}
#get data
library(engsoccerdata)
library(rvest)
#munging
library(tidyverse)
library(magrittr)
#spatial analysis
library(sf)
library(rgdal)
#for plotting maps
library(ggthemes)
```

The easiest way to get a total of points is using the engsoccerdata:: packages database of every English football match from the top four divisions (this does not include data from the 2017-2018, or 2018-2019 seasons). We can work out the points easily from the goals scored for each team

```{r get_data, warning=FALSE,message=FALSE}
#load the data
match_data <- engsoccerdata::england %>%
  #select only the necessary columns and melt
  select(season = Season, home, visitor, hgoal, vgoal, tier) %>%
  reshape2::melt(id.vars = c("season", "hgoal", "vgoal", "tier"),
                 variable.name = "location",
                 value.name = "team") %>%
  #will need to match this to location data so some club names need cleaning
  mutate(team_subbed = case_when(
    team == "Yeovil" ~ "Yeovil Town",
    team == "AFC Bournemouth" ~ "A.F.C. Bournemouth",
    team == "Halifax Town" ~ "F.C. Halifax Town",
    team == "Aldershot" ~ "Aldershot Town F.C",
    team == "Wimbledon" ~ "A.F.C. Wimbledon",
    team == "AFC Wimbledon" ~ "A.F.C. Wimbledon",
    team == "Macclesfield" ~ "Macclesfield Town",
    team == "Rushden & Diamonds" ~ "A.F.C. Rushden & Diamonds",
    team == "Milton Keynes Dons" ~ "Milton Keynes",
    team == "Dagenham and Redbridge" ~ "Dagenham & Redbridge",
    team == "Stevenage Borough" ~ "Stevenage"
  )) %>%
  #if cleaning isnt required, take original
  mutate(team_subbed = ifelse(is.na(team_subbed), team, team_subbed))

#peek at the data
head(match_data)
```

The 388k (194k matches) data.frame seems daunting, but actually only results in many fewer unique teams that have played at least one match in the top 4 divisions in England

```{r number_of_teams, message=FALSE,warning=FALSE}
length(unique(match_data$team_subbed))
```

The location of each club can then be found using the wikipedia pages for them/their stadia. This matches 121 of the 141 clubs pretty nicely which is a fairly good percentage all things considered

```{r match_clubs_wiki, message=FALSE,warning=FALSE}
#find the links to each clubs wikipedia page
wiki <- read_html("https://en.wikipedia.org/wiki/List_of_football_clubs_in_England") %>%
  html_nodes("td:nth-child(1)") %>%
  .[which(grepl("href", .))]

#get the names for each club
wiki_clubs <- wiki %>% html_text() %>% gsub(" \\(.*\\)$", "", .)

#can match 121/141 right off the bat
(unique(match_data$team_subbed) %in% wiki_clubs) %>%
  which() %>%
  length()

```

We can find the location of these matching clubs by finding the page for their stadia and then finding the coordinates. It's a bit of a messy function because I was just jamming stuff together to get data out as best as possible. This takes ~1 minute to run through all 121 teams (for the blog post I actually saved an RDS of the output from this and load it just to save time/server calls)

```{r load_scraped_data, warning=FALSE,message=FALSE,echo=FALSE}
matching_club_locations <- readRDS("C:/Users/Alaa/Desktop/geo_data/knowledge/scraped_locations.rds")
```

```{r find_club_locations, warning=FALSE,message=FALSE,eval=FALSE}
matching_club_locations <- wiki %>% 
  #take only the matching clubs
  .[which(wiki_clubs %in% unique(match_data$team_subbed))] %>%
  html_nodes("a") %>%
  #get the wiki page link
  html_attr("href") %>%
  paste0("https://en.wikipedia.org", .) %>%
  #for each club page find the stadium and its coordinates
  lapply(., function(team) {
    link <- read_html(team) %>%
      html_nodes(".label a") %>%
      .[1] %>%
      html_attr("href") %>% 
      paste0("https://en.wikipedia.org",. )
    coords <- link %>%
      read_html() %>% 
      html_nodes("#coordinates a") %>%
      html_attr("href") %>%
      .[2]
    #if coords not found use NA
    if(is.na(coords)) {
      coord_df <- data.frame(lat = NA,
                             lon = NA)
    } else {
      coords <- coords %>%
        paste0("https:", .) %>%
        read_html() %>%
        html_nodes(".geo") %>%
        html_text() %>%
        strsplit(., split = ", ")
      coord_df <- data.frame(lat = as.numeric(coords[[1]][1]),
                             lon = as.numeric(coords[[1]][2]))
    }
    return(coord_df)
  })  %>%
  #bind everything together
  do.call(rbind, .) %>%
  #add the club name as a new column
  mutate(team = wiki_clubs[
    which(wiki_clubs %in% unique(match_data$team_subbed))
    ]) %>%
  #filter out missing data
  filter(!is.na(lat) & !is.na(lon))

```

Which gives us the location of 114 of our 141 clubs. Most of the remaining ones are now-defunct clubs (e.g. Middlesbrough Ironopolis, Leeds City etc.)

```{r missing_teams, warning=FALSE,message=FALSE}
missing_teams <- unique(match_data$team_subbed)[which(!unique(match_data$team_subbed) %in% matching_club_locations$team)]
missing_teams
```

Given it was a Saturday morning where I had nothing better to do, I simply located these clubs home grounds manually and created a data.frame for their locations. It's not really great practice but whatever.

These are then all bound together and converted to an sf spatial object with the correct projection

```{r bind_missing_locations, warning=FALSE,message=FALSE}
#add in the missing locations
missing_locations <- data.frame(
  lat = c(53.7646, 53.711772, 52.799, 53.049722, 54.5641, 53.42644, 52.8146,
          52.7743, 53.804722, 53.4359, 52.799, 53.7778, 53.428367, 51.48622,
          54.508425, 53.554914, 51.7127, 53.4292, 51.514431, 51.248386,
          52.060719, 54.265478, 51.906158, 52.328033, 53.7646, 51.405083, 53.9165),
  lon = c(-2.358, -2.477292, -1.6354, -2.1925, -1.2456, -1.34377, -1.6335, -1.1992,
          -3.048056, -3.0377, -1.6354, -1.5722, -1.370231, -2.583134, -1.534394,
          -2.650661, -3.4374, -3.0407, 0.034739, -0.754789, -2.717711, -0.418247,
          -2.060211, -0.5999, -2.358, -0.281944, -3.0247),
    team = as.character(missing_teams)
)

#bind together and convert to sf
all_locations <- rbind(matching_club_locations,
                       missing_locations) %>%
  st_as_sf(coords = c("lon", "lat"), crs = st_crs("+init=epsg:4326")) %T>%
  #make a quick plot of locations for sanity check
  plot()
  
```

Now that we have all the teams, we need the English historical county boundaries to group them by. I'd actually already used these for football analysis, looknig at [if an independent Yorkshire could win the World Cup](https://www.citymetric.com/horizons/football-could-independent-yorkshire-win-world-cup-3961).

Load the data (the boundary file can be download from the [Ordnance Survey](https://www.ordnancesurvey.co.uk/business-and-government/products/boundaryline.html)) and make a quick plot of the boundaries and teams

(I also created an sf object engwal which is just the counties from England and Wales selected out for background plotting)

```{r load_geo_data_hidden, warning=FALSE,message=FALSE,echo=FALSE}
counties <- readOGR(dsn = "C:/Users/Alaa/Desktop/geo_data/boundary/Data/Supplementary_Ceremonial",
                    layer = "Boundary-line-ceremonial-counties_region") %>%
  st_as_sf(., crs = st_crs("+init=epsg:27700")) %>%
  select(county = NAME) %>%
  st_transform(., crs = st_crs("+init=epsg:4326"))

engwal <- counties %>%
  .[c(1:54, 88, 90),]
  
```

```{r load_geo_data_show, warning=FALSE,message=FALSE,eval=FALSE}
#load the boundary file
counties <- readOGR(dsn = "path/to/file",
                    layer = "county_boundaries") %>%
  #convert to sf and project as northing/easting
  st_as_sf(., crs = st_crs("+init=epsg:27700")) %>%
  #only interested in the county name
  select(county = NAME) %>%
  #transform the projection to match that of the club locations
  st_transform(., crs = st_crs("+init=epsg:4326"))

engwal <- counties %>%
  .[c(1:54, 88, 90),]


```

```{r plot_team_locations, warning=FALSE,message=FALSE}
#make a quick plot of counties and teams
ggplot() +
  geom_sf(data = counties, fill = NA) +
  geom_sf(data = all_locations) +
  ggtitle("Location of Teams to have Played Top\n 4 English Football Divisions") +
  theme_minimal() +
  theme(axis.title=element_blank(),
        axis.text=element_blank(),
        axis.ticks=element_blank())

```


(by the way the artifacts around Bristol and the Wirral are from the OS dataset- it's very annoying)

Then we need to determine which teams are within which counties. The easiest way to do this is to use a spatial join of the team names in all_locations by which county they fall into (using st_contains from the sf package)

```{r}
#bind the team names to each county
counties %<>%
  st_join(., all_locations, join = st_contains) %>%
  #remove counties that contain zero teams
  filter(!is.na(team)) %>%
  mutate(county = as.character(county))

#quick plot of number of teams per county (missing = 0)
counties %>%
  group_by(county) %>%
  summarise(n_clubs = n()) %>%
  ggplot(data = .) +
  geom_sf(data = engwal) +
  geom_sf(aes(fill = n_clubs), colour = "black") +
  scale_fill_viridis_c(option = "plasma", name = "# clubs") +
  ggtitle("Number of Top 4 Division Playing\n Teams in each Ceremonial County") +
  theme_minimal() +
  theme(axis.title=element_blank(),
        axis.text=element_blank(),
        axis.ticks=element_blank())

```

Which shows that most English historic counties (and a few Welsh ones due to teams like Cardiff City/ Swansea City etc.) have at least 1 team that has competed in the top 4 flights of English football at some point (those that do not are: Isle of Wight, Rutland, Surrey, Warwickshire, West Sussex and Cornwall).

To finally get the total number of points won by these teams, the county data needs to be joined back onto the match data from the top. First I clean it up a bit then make the left_join by team name. Finally the number of points per match is calculated using case_when and points are grouped by county and summed

```{r calc_county_points, warning=FALSE,message=FALSE}
county_match_data <- match_data %>% 
  mutate(team = team_subbed) %>%
  select(-team_subbed) %>%
  left_join(., counties, by = "team") %>%
  mutate(points = case_when(
    location == "home" & hgoal > vgoal ~ 3,
    location == "visitor" & vgoal > hgoal ~ 3,
    location == "home" & hgoal < vgoal ~ 0,
    location == "visitor" & vgoal < hgoal ~ 0,
    hgoal == vgoal ~ 1
  ))

county_points <- county_match_data %>%
  group_by(county) %>%
  summarise(total_points = sum(points))

```

Perhaps unsurprisingly, the county with the most points is Greater London, with Greater Manchester following and other footballing hotspots/ large counties in the West Midlands, Lancashire and around Yorkshire in the trailing group

```{r most_points, message=FALSE,warning=FALSE}
head(arrange(county_points, -total_points))

```

By contrast, Worcestshire and Northumberland barely have any points, with a few Welsh counties also struggling

```{r least_points, message=FALSE,warning=FALSE}
head(arrange(county_points, total_points))

```

If we group by tier as well as county, it's possible to see how well each county has done at specific tiers. 

```{r}
county_match_data %>%
  group_by(county, tier) %>%
  summarise(total_points = sum(points)) %>%
  left_join(.,
            select(counties, county),
            by = "county") %>%
  ggplot(data = .) +
  geom_sf(data = engwal) +
  geom_sf(aes(fill = total_points), colour = "black") +
  scale_fill_viridis_c(option = "plasma", name = "total points") +
  ggtitle("Number of Points Won by each County\n per Tier of English Football") +
  facet_wrap(~tier) +
  theme_minimal() +
  theme(axis.title=element_blank(),
        axis.text=element_blank(),
        axis.ticks=element_blank())

```

And for the Premier League era this clears up to

```{r}
county_match_data %>%
  filter(season > 1991) %>%
  group_by(county, tier) %>%
  summarise(total_points = sum(points)) %>%
  left_join(.,
            select(counties, county),
            by = "county") %>%
  ggplot(data = .) +
  geom_sf(data = engwal) +
  geom_sf(aes(fill = total_points), colour = "black", name = "total points") +
  scale_fill_viridis_c(option = "plasma") +
  ggtitle("Number of Points Won by each County\n per Tier of English Football",
          subtitle = "From Begining of 1992/1993 Season") +
  facet_wrap(~tier) +
  theme_minimal() +
  theme(axis.title=element_blank(),
        axis.text=element_blank(),
        axis.ticks=element_blank())

```

Which shows just how dominant London has been in the top division of English football (especially as it is only competitive at lower levels).

I had wanted to weight points by the average ELO of that league and see which county has the most weight-adjusted points but got bored for this small blog post.

Best,

