---
title: "The Guardian Knowledge June 2019"
author: "Robert Hickman"
date: '2019-06-20'
output:
  html_document:
    df_print: paged
header:
  caption: ''
  image: ''
slug: guardian_knowledge_june
tags:
- rstats
- football
- the_knowledge
categories: []
---

Most wednesday's I enjoy reading [The Knowledge](https://www.theguardian.com/football/series/theknowledge) blog on the Guardian's website and reading the football trivia therein. When time (and questions) allow, I like to answer some of the questions posed, example of which are [here](http://www.robert-hickman.eu/post/the-knowledge-4th-august-2018/), [here](http://www.robert-hickman.eu/post/counties_league_points/), and [here](http://www.robert-hickman.eu/post/the-knowledge-7th-february-2019/).

# League of Nations

The first question comes from

<blockquote class="twitter-tweet" data-lang="en"><p lang="en" dir="ltr">Which player had the nationality with the lowest FIFA World Ranking at the time of him winning the Premier League?</p>&mdash; The Tin Boonie (@TheTinBoonie) <a href="https://twitter.com/TheTinBoonie/status/1140936272862691328?ref_src=twsrc%5Etfw">June 18, 2019</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

a similar question is also answered in thi weeks column:

'*“Fulham defender Zesh Rehman made his debut for Pakistan, who are ranked 168 by Fifa. Is that the lowest-ranked country a Premier League player has played for?”* wondered Zulfiqar Shah in January 2006.'

I thought I'd answer both of these using R.

First some libraries we'll need, and also set a seed for reproducibility.

```{r libraries, warning=FALSE,message=FALSE}
library(tidyverse)
library(magrittr)
library(rvest)

set.seed(3459)
```


The first thing we need to answer these is the nationality of EPL players. For this two good sources are [transfermarkt.co.uk](https://www.transfermarkt.co.uk/) and [11v11.com](https://www.11v11.com/). I'm going to opt for the later, just because the tables are a little easier to scrape.

To start, we need to get the links to every team to have competed in the premier league

```{r epl_teams, warning=FALSE,message=FALSE}
# get years of EPL seasons
years <- 1993:2019
# base url we'll scrape from
base_url <- "https://www.11v11.com"

# cat together
tables <- paste0(base_url, "/league-tables/premier-league/01-june-", years)

competing_teams <- tables %>%
  # get a list of the links to every teams squad page
  map(., function(x) {
    x %>%
      read_html() %>%
      html_nodes("#table-league > tbody:nth-child(2) > tr > td:nth-child(2) > a:nth-child(1)") %>%
      html_attr("href") %>%
      # paste into working link for year and competition (EPL)
      paste0(base_url, ., "tab/players/season/", gsub(".*01-june-", "", x), "/comp/1/")
  }) %>%
  unlist()

head(competing_teams, n = 5)

```

We can then scrape the squads for these teams in that specific season. We want the players, their nationality and also the number of appearances they made in the league that season

```{r get_squads, warning=FALSE,message=FALSE,eval=FALSE}
squads <- competing_teams %>%
  # get the players/appearances/nationalities
  map_df(., function(y) {
    # read once to save server calls
    read <- y %>%
      read_html() 
    
    # get the squad info
    squad <- read %>%
      html_nodes(".squad") %>%
      html_table(fill = TRUE) %>%
      as.data.frame() %>%
      # get rid of rows without player info
      filter(!is.na(Player))
    
    # get the listed nationalities
    flags <- read %>%
      html_nodes(".squad > tbody:nth-child(2) > tr > td:nth-child(3)")
    
    # from here get the actual nationalities per player
    nations <- flags %>%
      html_nodes("img") %>%
      html_attr("title")
    
    # these might mismatch in length
    # in which case append NA
    if(length(flags) != length(nations)) {
      missing <- which(!grepl("img", flags))
      
      nations <- c(nations[1:(missing-1)], NA, nations[missing:length(nations)])
    }
    
    # mutate nationality and team and season
    squad %>%
      mutate(nation = nations,
             year = gsub(".*season\\/", "", gsub("\\/comp.*", "", y)),
             team = gsub("\\/tab\\/players.*", "", gsub(".*teams\\/", "", y))) %>%
      # select useful appearance information
      select(player = Player, position = Position,
             appearances = A, sub_appearances = S, 
             nation, year, team)
  }) %>%
  # manually add in some missing nationalities
  mutate(nation = case_when(
    grepl("Steffen Karl", player) ~ "Germany",
    grepl("Marc Muniesa", player) ~ "Spain",
    grepl("Oriol Romeu", player) ~ "Spain",
    grepl("Aleix García", player) ~ "Spain",
    grepl("Martín Montoya", player) ~ "Spain",
    TRUE ~ nation
  ))

head(squads, n = 10)

```

```{r load_squads, warning=FALSE,message=FALSE}
squads <- readRDS("C:/Users/rob-getty/Desktop/squads.rds")
```

To answer the question as asked, we'd want historical [FIFA ranking](https://www.fifa.com/fifa-world-ranking/ranking-table/men/) data. While it does exist going back to 2007, I'd prefer to have the full dataset back to 1993, and in any case, there are also [some problems](https://en.wikipedia.org/wiki/World_Football_Elo_Ratings) with the historical calculation FIFA used for it's ratings.

```{r}
elo_data <- readRDS("../../scraped_elo_ratings.rds") %>%
  select(date, home, away, rating_home = r1, rating_away = r2, ranking_home = ranking1, ranking_away = ranking2) %>%
  gather("location", "nation", -rating_home, -rating_away, -ranking_home, -ranking_away, -date) %>%
  gather("measure", "value", -nation, -date, -location) %>%
  filter((location == "home" & measure %in% c("rating_home", "ranking_home")) |
           (location == "away" & measure %in% c("rating_away", "ranking_away"))) %>%
  separate(measure, into = c("measure", "location"), "_") %>%
  filter(!duplicated(.)) %>%
  filter(date > "1992-01-01")


```



```{r check_nation_names, warning=FALSE,message=FALSE}
squad_teams <- unique(squads$nation)
rating_teams <- unique(elo_data$nation)

squad_teams[!squad_teams %in% rating_teams]

```

```{r combine_elo_data, warning=FALSE,message=FALSE}
players_national_elo <- squads %>%
  mutate(nation = case_when(
    grepl("Ireland Republic", nation) ~ "Republic of Ireland",
    grepl("Trinidad and Tobago", nation) ~ "Trinidad/Tobago",
    grepl("Macedonia FYR", nation) ~ "Macedonia",
    grepl("St. Kitts and Nevis", nation) ~ "St Kitts and Nevis",
    grepl("Bosnia and Herzegovina", nation) ~ "Bosnia/Herzeg",
    grepl("Congo DR", nation) ~ "DR Congo",
    grepl("Antigua and Barbuda", nation) ~ "Antigua/Barbuda",
    grepl("Korea Republic", nation) ~ "South Korea",
    grepl("Curacao", nation) ~ "Curaçao",
    grepl("Cape Verde Islands", nation) ~ "Cape Verde",
    grepl("Equatorial Guinea", nation) ~ "Equat Guinea",
    TRUE ~ nation
  )) %>%
  mutate(year = as.numeric(year)) %>%
  mutate(s_start = as.Date(paste0(year-1, "-08-01")),
         s_end = as.Date(paste0(year, "-06-01"))) %>%
  left_join(., elo_data, by = "nation") %>%
  filter(date > s_start & date < s_end)

p2 <- players_national_elo %>%
  arrange(rating) %>%
  filter(!duplicated(paste(player, team, year), fromLast = TRUE)) %>%
  mutate(decade = case_when(
    year < 2000 ~ "1990",
    year < 2010 ~ "2000",
    year < 2020 ~ "2010"
  )) %>%
  ggplot(aes(rating)) +
  geom_histogram() +
  labs(title = "",
       subtitle = "",
       x = "lowest national team ELO rating",
       y = "player count") +
  theme_minimal() +
  facet_wrap(~decade)

plot(p2)

```

```{r worst_elo_players, warning=FALSE,message=FALSE}
worst_national_team_players <- players_national_elo %>%
  arrange(rating) %>%
  filter(appearances > 0) %>%
  filter(!duplicated(player)) %>%
  select(year, team, player, nation, rating)

head(worst_national_team_players, n = 25)

```

```{r worst_epl_winning_rankings, warning=FALSE,message=FALSE}
epl_winners <- data.frame(
  champion = c(
    "manchester-united",
    "manchester-united",
    "blackburn-rovers",
    "manchester-united",
    "manchester-united",
    "arsenal",
    "manchester-united",
    "manchester-united",
    "manchester-united",
    "arsenal",
    "manchester-united",
    "arsenal",
    "chelsea",
    "chelsea",
    "manchester-united",
    "manchester-united",
    "manchester-united",
    "chelsea",
    "manchester-united",
    "manchester-city",
    "manchester-united",
    "manchester-city",
    "chelsea",
    "leicester-city",
    "chelsea",
    "manchester-city",
    "manchester-city"),
  year = 1993:2019
) 

get_nation_ranking <- function(season_end_date, player_nationality) {
  df <- elo_data %>%
    filter(date < season_end_date) %>%
    filter(!duplicated(nation, fromLast = TRUE)) %>%
    arrange(-rating) %>%
    mutate(ranking = seq(nrow(.))) %>%
    filter(nation == player_nationality) %>%
    select(ranking)
}

epl_winning_squads <- players_national_elo %>%
  left_join(., epl_winners, by = "year") %>%
  filter(team == champion) %>%
  arrange(rating) %>%
  filter(appearances > 0 | sub_appearances > 0) %>%
  filter(!duplicated(paste(player, year), fromLast = TRUE)) %>%
  bind_cols(map2_df(.$s_end, .$nation, get_nation_ranking)) %>%
  select(year, team, player, apps = appearances, sub_apps = sub_appearances, nation, rating, ranking) %>%
  arrange(-ranking, rating)

head(epl_winning_squads, n = 25)

  
  
  
```

```{r}
test <- "http://www.eloratings.net/Northern_Ireland" %>%
  read_html() %>%
  html_nodes(xpath = "#maintable_Brazil") %>%
  html_table()
```

